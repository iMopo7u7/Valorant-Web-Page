<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin Valorant</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
nav { background:#333; }
nav ul { list-style:none; display:flex; margin:0; padding:0; }
nav li { margin:0; }
nav a { display:block; padding:1rem; color:white; text-decoration:none; }
nav a.active { background:#555; }
main { padding:1rem; }
form.form-inline input, form.form-inline select { margin-right:0.5rem; margin-bottom:0.3rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
section { display:none; }
section.active { display:block; }
.edit-form { background:#f9f9f9; padding:0.5rem; margin-top:0.5rem; border:1px solid #ccc; }
.edit-form input { margin-right:0.5rem; margin-bottom:0.3rem; }
</style>
</head>
<body>

<header><h1>PANEL DE ADMINISTRADOR</h1></header>

<nav>
  <ul>
    <li><a href="#dashboard" class="active">Dashboard</a></li>
    <li><a href="#players">Gestionar Jugadores</a></li>
    <li><a href="#addMatch">Agregar Partida</a></li>
    <li><a href="#matches">Partidas</a></li>
    <li><a href="/events.html">Eventos</a></li>
    <li><a href="#" id="logoutBtn">Cerrar Sesión</a></li>
  </ul>
</nav>

<main>
  <section id="dashboard" class="active">
    <h2>Dashboard / Resumen</h2>
    <p>Total Jugadores: <span id="totalPlayers">0</span></p>
    <p>Partidas Registradas: <span id="totalMatches">0</span></p>
    <p>Última partida agregada: <span id="lastMatchDate">N/A</span></p>
  </section>

  <section id="players">
    <h2>Gestionar Jugadores</h2>
    <form id="addPlayerForm" class="form-inline">
      <input type="text" id="playerName" placeholder="Nombre" required>
      <input type="text" id="playerTag" placeholder="Tag" required>
      <input type="text" id="playerTwitch" placeholder="Twitch (opcional)">
      <input type="text" id="playerTwitter" placeholder="Twitter (opcional)">
      <input type="text" id="playerTracker" placeholder="Valorant Tracker (opcional)">
      <button type="submit">Registrar</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tag</th>
          <th>Partidas</th>
          <th>Kills</th>
          <th>Deaths</th>
          <th>Assists</th>
          <th>Redes</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="playersTableBody">
        <tr><td colspan="8">No hay jugadores registrados</td></tr>
      </tbody>
    </table>
  </section>

  <section id="addMatch">
    <h2>Agregar Partida</h2>
    <!-- Tu sección de agregar partida queda igual -->
  </section>

  <section id="matches">
    <h2>Partidas</h2>
    <!-- Tabla de partidas igual -->
  </section>
</main>

<script>
const API_URL = window.location.origin;
let allPlayers = [];
let allMatches = [];

// Navegación
document.querySelectorAll('nav a').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('nav a').forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('section').forEach(s => s.style.display='none');
    const target = document.querySelector(link.getAttribute('href'));
    if(target) target.style.display='block';
  });
});
document.querySelectorAll('section')[0].style.display='block';

// Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await fetch('/logout',{method:'POST', credentials:'include'});
  window.location.href = '/login.html';
});

// Cargar jugadores
async function loadPlayers(){
  const res = await fetch('/players',{credentials:'include'});
  allPlayers = await res.json();
  updatePlayersTable();
  populateTeams();
  updateDashboard();
}

// Actualizar tabla
function updatePlayersTable(){
  const tbody = document.getElementById('playersTableBody');
  tbody.innerHTML = '';
  if(!allPlayers.length){ tbody.innerHTML='<tr><td colspan="8">No hay jugadores registrados</td></tr>'; return; }

  allPlayers.forEach(p=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${p.name}</td>
      <td>${p.tag}</td>
      <td>${p.matchesPlayed||0}</td>
      <td>${p.totalKills||0}</td>
      <td>${p.totalDeaths||0}</td>
      <td>${p.totalAssists||0}</td>
      <td>
        ${p.social?.twitch?`T:${p.social.twitch} `:''}
        ${p.social?.twitter?`Tw:${p.social.twitter} `:''}
        ${p.social?.tracker?`Tr:${p.social.tracker}`:''}
      </td>
      <td>
        <button class="btn-edit">Editar</button>
        <button class="btn-delete">Eliminar</button>
      </td>`;
    tbody.appendChild(row);

    row.querySelector('.btn-edit').addEventListener('click', ()=> editPlayer(p._id));
    row.querySelector('.btn-delete').addEventListener('click', ()=> deletePlayer(p._id));
  });
}

// Editar jugador inline
async function editPlayer(playerId){
  const player = allPlayers.find(p=>p._id===playerId);
  if(!player) return;

  const row = [...document.querySelectorAll('#playersTableBody tr')].find(r=>r.querySelector('.btn-edit') && allPlayers.find(p=>p._id===playerId));
  row.innerHTML = `
    <td><input value="${player.name}" class="edit-name"></td>
    <td><input value="${player.tag}" class="edit-tag"></td>
    <td>${player.matchesPlayed||0}</td>
    <td>${player.totalKills||0}</td>
    <td>${player.totalDeaths||0}</td>
    <td>${player.totalAssists||0}</td>
    <td>
      <input placeholder="Twitch" class="edit-twitch" value="${player.social?.twitch||''}">
      <input placeholder="Twitter" class="edit-twitter" value="${player.social?.twitter||''}">
      <input placeholder="Tracker" class="edit-tracker" value="${player.social?.tracker||''}">
    </td>
    <td>
      <button class="btn-save">Guardar</button>
      <button class="btn-cancel">Cancelar</button>
    </td>`;

  row.querySelector('.btn-cancel').addEventListener('click',()=>loadPlayers());
  row.querySelector('.btn-save').addEventListener('click', async ()=>{
    const newName = row.querySelector('.edit-name').value.trim();
    const newTag = row.querySelector('.edit-tag').value.trim();
    const social = {
      twitch: row.querySelector('.edit-twitch').value.trim(),
      twitter: row.querySelector('.edit-twitter').value.trim(),
      tracker: row.querySelector('.edit-tracker').value.trim()
    };

    if(!newName||!newTag) return alert('Nombre y tag requeridos');

    const res = await fetch('/players',{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id: playerId, newName, newTag, social })
    });
    const data = await res.json();
    if(!res.ok) return alert(data.error||'Error al actualizar');
    loadPlayers();
  });
}

// Eliminar jugador
async function deletePlayer(playerId){
  const player = allPlayers.find(p=>p._id===playerId);
  if(!player) return;
  if(!confirm(`Eliminar jugador ${player.name}?`)) return;

  const res = await fetch('/players',{
    method:'DELETE',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify({ id: playerId })
  });
  const data = await res.json();
  if(!res.ok) return alert(data.error||'Error al eliminar');
  loadPlayers();
}

// Dashboard
async function updateDashboard(){
  document.getElementById('totalPlayers').innerText = allPlayers.length;
  const resMatches = await fetch('/matches-count',{credentials:'include'});
  const dataMatches = await resMatches.json();
  document.getElementById('totalMatches').innerText = dataMatches.count||0;
  const resLast = await fetch('/last-match',{credentials:'include'});
  const last = await resLast.json();
  document.getElementById('lastMatchDate').innerText = last.date? new Date(last.date).toLocaleString():'N/A';
}

// Equipos
function populateTeams(){ /* Igual que antes */ }

// Inicializar
loadPlayers();
</script>

</body>
</html>
