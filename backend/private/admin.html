<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Valorant 10-mans</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
main { padding:1rem; max-width:1200px; margin:auto; }
button { cursor:pointer; margin:0.2rem; padding:0.3rem 0.5rem; }
table { width:100%; border-collapse: collapse; margin-top:1rem; background:white; }
table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
input, select { padding:0.25rem; margin:0.2rem; }
.team-row { display:flex; gap:0.2rem; margin-bottom:0.2rem; flex-wrap:wrap; align-items:center; }
#matchesContainer { margin-top:1rem; }
.active { background:#d0e6f7; }
</style>
</head>
<body>

<header><h1>ADMINISTRACIÃ“N - PARTIDAS VALORANT</h1></header>

<main>
  <h2>Jugadores</h2>
  <div id="playerForm" class="team-row">
    <input type="text" id="playerName" placeholder="Nombre">
    <input type="text" id="playerTag" placeholder="Tag">
    <button id="addPlayerBtn">Agregar</button>
  </div>
  <table>
    <thead>
      <tr><th>Nombre</th><th>Tag</th><th>Acciones</th></tr>
    </thead>
    <tbody id="playersTableBody">
      <tr><td colspan="3">Cargando...</td></tr>
    </tbody>
  </table>

  <h2>Registrar Partida</h2>
  <div id="matchesContainer">Selecciona jugadores para armar equipos y registrar la partida</div>
</main>

<script>
const API_URL = window.location.origin;
let allPlayers = [], teamA = [], teamB = [];

// --- Jugadores ---
async function loadPlayers() {
  const res = await fetch('/players', {credentials:'include'});
  allPlayers = res.ok ? await res.json() : [];
  renderPlayers();
}

function renderPlayers() {
  const tbody = document.getElementById('playersTableBody');
  tbody.innerHTML='';
  if(!allPlayers.length){ tbody.innerHTML='<tr><td colspan="3">No hay jugadores</td></tr>'; return; }
  allPlayers.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td>${p.tag}</td>
      <td>
        <button class="editBtn">Editar</button>
        <button class="delBtn">Eliminar</button>
        <button class="addA">Agregar A</button>
        <button class="addB">Agregar B</button>
      </td>`;
    tbody.appendChild(tr);

    tr.querySelector('.editBtn').addEventListener('click',()=>editPlayer(p));
    tr.querySelector('.delBtn').addEventListener('click',()=>deletePlayer(p));
    tr.querySelector('.addA').addEventListener('click',()=>addToTeam(p,'A'));
    tr.querySelector('.addB').addEventListener('click',()=>addToTeam(p,'B'));
  });
}

document.getElementById('addPlayerBtn').addEventListener('click', async()=>{
  const name=document.getElementById('playerName').value.trim();
  const tag=document.getElementById('playerTag').value.trim();
  if(!name||!tag) return alert('Completa nombre y tag');
  const res = await fetch('/players', {
    method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
    body:JSON.stringify({name, tag})
  });
  if(!res.ok) return alert('Error al agregar jugador');
  document.getElementById('playerName').value=''; document.getElementById('playerTag').value='';
  loadPlayers();
});

async function editPlayer(p){
  const newName = prompt("Nuevo nombre", p.name);
  const newTag = prompt("Nuevo tag", p.tag);
  if(!newName||!newTag) return;
  const res = await fetch('/players', {
    method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include',
    body:JSON.stringify({oldName:p.name, oldTag:p.tag, newName, newTag})
  });
  if(!res.ok) return alert('Error actualizando jugador');
  loadPlayers();
}

async function deletePlayer(p){
  if(!confirm(`Eliminar ${p.name}?`)) return;
  const res = await fetch('/players', {
    method:'DELETE', headers:{'Content-Type':'application/json'}, credentials:'include',
    body:JSON.stringify({name:p.name, tag:p.tag})
  });
  if(!res.ok) return alert('Error eliminando jugador');
  teamA = teamA.filter(pl=>pl.name!==p.name);
  teamB = teamB.filter(pl=>pl.name!==p.name);
  renderMatchForm();
  loadPlayers();
}

// --- Equipos ---
function addToTeam(p,team){
  if(team==='A' && !teamA.find(pl=>pl.name===p.name)) teamA.push({...p});
  if(team==='B' && !teamB.find(pl=>pl.name===p.name)) teamB.push({...p});
  renderMatchForm();
}

// --- Formulario de Partida ---
function renderMatchForm(){
  const container = document.getElementById('matchesContainer');
  container.innerHTML='';
  if(!teamA.length && !teamB.length){ container.innerHTML='Selecciona jugadores para armar equipos'; return; }

  const div = document.createElement('div');
  div.innerHTML=`<h4>Equipo A (${teamA.length}) vs Equipo B (${teamB.length})</h4>`;

  function renderTeam(team, label){
    const tDiv = document.createElement('div');
    tDiv.innerHTML=`<strong>Equipo ${label}</strong>`;
    team.forEach((p,i)=>{
      const row = document.createElement('div');
      row.className='team-row';
      row.innerHTML=`
        <span>${p.name}</span>
        <input type="number" placeholder="Kills" min="0">
        <input type="number" placeholder="Deaths" min="0">
        <input type="number" placeholder="Assists" min="0">
        <input type="number" placeholder="ACS" min="0">
        <input type="number" placeholder="HS%" min="0">
        <input type="number" placeholder="FirstBloods" min="0">
      `;
      tDiv.appendChild(row);
    });
    return tDiv;
  }

  div.appendChild(renderTeam(teamA,'A'));
  div.appendChild(renderTeam(teamB,'B'));

  const mapInput = document.createElement('input'); mapInput.placeholder='Mapa';
  const scoreInput = document.createElement('input'); scoreInput.placeholder='Score final (ej. 13-10)';
  const winnerSelect = document.createElement('select');
  winnerSelect.innerHTML='<option value="">Equipo ganador</option><option value="A">A</option><option value="B">B</option>';

  div.appendChild(mapInput); div.appendChild(scoreInput); div.appendChild(winnerSelect);

  const saveBtn = document.createElement('button');
  saveBtn.innerText='Registrar Partida';
  saveBtn.addEventListener('click', async()=>{
    if(!teamA.length || !teamB.length) return alert('Agrega jugadores a ambos equipos');
    const map = mapInput.value.trim();
    const score = scoreInput.value.trim();
    const winnerTeam = winnerSelect.value;
    if(!map || !score || !winnerTeam) return alert('Completa todos los campos');

    const matchData = [...teamA,...teamB].map((p,i)=>{
      const row = div.querySelectorAll('.team-row')[i];
      return {
        name:p.name, tag:p.tag,
        kills:parseInt(row.children[1].value)||0,
        deaths:parseInt(row.children[2].value)||0,
        assists:parseInt(row.children[3].value)||0,
        acs:parseInt(row.children[4].value)||0,
        hsPercent:parseInt(row.children[5].value)||0,
        firstBloods:parseInt(row.children[6].value)||0
      };
    });

    const res = await fetch('/matches', {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body:JSON.stringify({match:matchData, winnerTeam, score, map})
    });
    if(!res.ok) return alert('Error registrando partida');
    alert('Partida registrada');
    teamA=[]; teamB=[]; renderMatchForm(); loadPlayers();
  });

  div.appendChild(saveBtn);
  container.appendChild(div);
}

// --- Init ---
loadPlayers();
</script>

</body>
</html>
