<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin Valorant</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
nav { background:#333; }
nav ul { list-style:none; display:flex; margin:0; padding:0; flex-wrap: wrap; }
nav li { margin:0; }
nav a { display:block; padding:1rem; color:white; text-decoration:none; }
nav a.active { background:#555; }
main { padding:1rem; }
form input, form select { margin-right:0.5rem; margin-bottom:0.3rem; padding:0.3rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; background:white; }
table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
section { display:none; }
section.active { display:block; }
.edit-row input { width: 90%; }
.team-row input, .team-row select { margin-right:0.3rem; margin-bottom:0.2rem; width: 80px; }
.alert { color: green; margin-top: 0.5rem; display:block; }
.player-row input, .team-row input, .team-row select { text-align:center; }
textarea { width:100%; margin-top:0.5rem; margin-bottom:0.5rem; }
</style>
</head>
<body>

<header><h1>PANEL DE ADMINISTRADOR</h1></header>

<nav>
  <ul>
    <li><a href="#dashboard" class="active">Dashboard</a></li>
    <li><a href="#players">Gestionar Jugadores</a></li>
    <li><a href="#addMatch">Agregar Partida</a></li>
    <li><a href="#matches">Partidas</a></li>
    <li><a href="#" id="logoutBtn">Cerrar Sesión</a></li>
  </ul>
</nav>

<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <h2>Dashboard / Resumen</h2>
    <p>Total Jugadores: <span id="totalPlayers">0</span></p>
    <p>Partidas Registradas: <span id="totalMatches">0</span></p>
    <p>Última partida agregada: <span id="lastMatchDate">N/A</span></p>
  </section>

  <!-- GESTIONAR JUGADORES -->
  <section id="players">
    <h2>Gestionar Jugadores</h2>
    <form id="addPlayerForm">
      <input type="text" id="playerName" placeholder="Nombre" required>
      <input type="text" id="playerTag" placeholder="Tag" required>
      <button type="submit">Registrar</button>
      <span id="playerAlert" class="alert"></span>
    </form>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tag</th>
          <th>Partidas</th>
          <th>Kills</th>
          <th>Deaths</th>
          <th>Assists</th>
          <th>ACS</th>
          <th>DDDelta</th>
          <th>ADR</th>
          <th>KAST</th>
          <th>FK</th>
          <th>FD</th>
          <th>MK</th>
          <th>Redes / Avatar</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="playersTableBody">
        <tr><td colspan="15">No hay jugadores registrados</td></tr>
      </tbody>
    </table>
  </section>

  <!-- AGREGAR PARTIDA -->
  <section id="addMatch">
    <h2>Agregar Partida</h2>
    <div id="addMatchForm" style="margin-bottom:1rem;">
      <label>Mapa:</label>
      <select id="matchMap">
        <option value="">Selecciona mapa</option>
        <option value="Bind">Bind</option>
        <option value="Haven">Haven</option>
        <option value="Split">Split</option>
        <option value="Ascent">Ascent</option>
        <option value="Icebox">Icebox</option>
        <option value="Breeze">Breeze</option>
        <option value="Corrode">Corrode</option>
        <option value="Abyss">Abyss</option>
        <option value="Sunset">Sunset</option>
        <option value="Lotus">Lotus</option>
        <option value="Pearl">Pearl</option>
        <option value="Fracture">Fracture</option>
      </select>
      <label>Ganador:</label>
      <select id="winnerTeam">
        <option value="">Seleccionar</option>
        <option value="A">Equipo A</option>
        <option value="B">Equipo B</option>
      </select>
      <label>Marcador final:</label>
      <input type="text" id="matchScore" placeholder="Ej: 13-8">

      <!-- NUEVA FUNCIONALIDAD: CARGAR JSON -->
      <textarea id="jsonInput" rows="6" placeholder='Pega aquí el JSON de la partida'></textarea>
      <button type="button" id="loadJsonBtn">Cargar JSON</button>

      <h4>Equipo A</h4>
      <div id="teamA"></div>
      <h4>Equipo B</h4>
      <div id="teamB"></div>

      <button id="submitMatchBtn">Registrar Partida</button>
      <span id="matchAlert" class="alert"></span>
    </div>
  </section>

  <!-- PARTIDAS -->
  <section id="matches">
    <h2>Partidas</h2>
    <table>
      <thead>
        <tr>
          <th>Mapa</th>
          <th>Score</th>
          <th>Ganador</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="matchesTableBody">
        <tr><td colspan="5">No hay partidas registradas</td></tr>
      </tbody>
    </table>
  </section>
</main>

<script>
const API_URL = window.location.origin;
let allPlayers = [];
let allMatches = [];

document.addEventListener('DOMContentLoaded', () => {

  const navLinks = document.querySelectorAll('nav a');
  const sections = document.querySelectorAll('section');
  navLinks.forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      navLinks.forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      sections.forEach(s => s.style.display = 'none');
      const target = document.querySelector(link.getAttribute('href'));
      if(target) target.style.display = 'block';
    });
  });
  sections[0].style.display = 'block';

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await fetch('/logout', { method: 'POST', credentials: 'include' });
    window.location.href = '/login.html';
  });

  document.getElementById('addPlayerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('playerName').value.trim();
    const tag = document.getElementById('playerTag').value.trim();
    if(!name || !tag) return alert('Nombre y tag son obligatorios');

    try {
      const res = await fetch('/players', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ name, tag, social:{} })
      });
      const data = await res.json();
      if(!res.ok) return alert(data.error||'Error al agregar jugador');
      document.getElementById('playerName').value = '';
      document.getElementById('playerTag').value = '';
      document.getElementById('playerAlert').innerText = 'Jugador registrado correctamente';
      setTimeout(()=>document.getElementById('playerAlert').innerText='',2000);
      loadPlayers();
    } catch(err){ console.error(err); alert('Error de conexión'); }
  });

  loadPlayers();
  loadMatches();
});

// --- Funciones de jugadores y dashboard (igual que tu código original) ---
async function loadPlayers() {
  const res = await fetch('/players', { credentials:'include' });
  allPlayers = await res.json();
  updatePlayersTable();
  populateTeams();
  updateDashboard();
}

function updatePlayersTable() {
  const tbody = document.getElementById('playersTableBody');
  tbody.innerHTML = '';
  if(!allPlayers.length){ tbody.innerHTML='<tr><td colspan="15">No hay jugadores registrados</td></tr>'; return; }

  allPlayers.forEach((p,index)=>{
    const row = document.createElement('tr');
    row.classList.add('player-row');
    row.innerHTML = `
      <td><input type="text" value="${p.name}" class="edit-name"></td>
      <td><input type="text" value="${p.tag}" class="edit-tag"></td>
      <td>${p.matchesPlayed||0}</td>
      <td>${p.totalKills||0}</td>
      <td>${p.totalDeaths||0}</td>
      <td>${p.totalAssists||0}</td>
      <td>${p.totalACS||0}</td>
      <td>${p.totalDDDelta||0}</td>
      <td>${p.totalADR||0}</td>
      <td>${p.totalKAST||0}</td>
      <td>${p.totalFK||0}</td>
      <td>${p.totalFD||0}</td>
      <td>${p.totalMK||0}</td>
      <td>
        <input type="text" placeholder="Tracker" value="${p.social?.tracker||''}" class="edit-tracker"><br>
        <input type="text" placeholder="Twitter" value="${p.social?.twitter||''}" class="edit-twitter"><br>
        <input type="text" placeholder="Twitch" value="${p.social?.twitch||''}" class="edit-twitch"><br>
        <input type="text" placeholder="URL Avatar Discord" value="${p.avatarURL||''}" class="edit-avatar">
      </td>
      <td>
        <button class="btn-save">Guardar</button>
        <button class="btn-delete">Eliminar</button>
        <span class="alert edit-alert" style="margin-left:5px;color:green;"></span>
      </td>
    `;
    tbody.appendChild(row);

    row.querySelector('.btn-save').addEventListener('click', async () => {
      const newName = row.querySelector('.edit-name').value.trim();
      const newTag = row.querySelector('.edit-tag').value.trim();
      const tracker = row.querySelector('.edit-tracker').value.trim();
      const twitter = row.querySelector('.edit-twitter').value.trim();
      const twitch = row.querySelector('.edit-twitch').value.trim();
      const avatarURL = row.querySelector('.edit-avatar').value.trim();
      if(!newName||!newTag) return alert('Nombre y tag son obligatorios');

      try{
        const res = await fetch('/players',{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({
            oldName:p.name,
            oldTag:p.tag,
            newName,
            newTag,
            social:{tracker,twitter,twitch},
            avatarURL
          })
        });
        if(!res.ok) return alert((await res.json()).error||'Error actualizando jugador');
        row.querySelector('.edit-alert').innerText='Editado correctamente';
        setTimeout(()=>row.querySelector('.edit-alert').innerText='',2000);
        loadPlayers();
      }catch(err){ console.error(err); alert('Error de conexión'); }
    });

    row.querySelector('.btn-delete').addEventListener('click', async () => {
      if(!confirm(`Eliminar jugador ${p.name}?`)) return;
      const res = await fetch('/players',{
        method:'DELETE',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ name:p.name, tag:p.tag })
      });
      if(!res.ok) return alert((await res.json()).error||'Error eliminando jugador');
      loadPlayers();
    });
  });
}

async function updateDashboard(){
  document.getElementById('totalPlayers').innerText=allPlayers.length;
  const resMatches=await fetch('/matches-count',{credentials:'include'});
  const dataMatches=await resMatches.json();
  document.getElementById('totalMatches').innerText=dataMatches.count||0;
  const resLast=await fetch('/last-match',{credentials:'include'});
  const last=await resLast.json();
  document.getElementById('lastMatchDate').innerText=last.date?new Date(last.date).toLocaleString():'N/A';
}

function populateTeams(){
  const teamA=document.getElementById('teamA'); const teamB=document.getElementById('teamB');
  teamA.innerHTML=''; teamB.innerHTML='';
  const createRow=()=>{ const row=document.createElement('div'); row.className='team-row';
    row.innerHTML=`
      <select class="player-select"><option value="">-- Selecciona jugador --</option>${allPlayers.map(p=>`<option value="${p.name}||${p.tag}">${p.name} (${p.tag})</option>`).join('')}</select>
      <select class="character-select">
        <option value="">-- Personaje --</option>
        <option value="Jett">Jett</option>
        <option value="Reyna">Reyna</option>
        <option value="Phoenix">Phoenix</option>
        <option value="Raze">Raze</option>
        <option value="Yoru">Yoru</option>
        <option value="Neon">Neon</option>
        <option value="Iso">Iso</option>
        <option value="Waylay">Waylay</option>
        <option value="Sova">Sova</option>
        <option value="Skye">Skye</option>
        <option value="KAY/O">KAY/O</option>
        <option value="Fade">Fade</option>
        <option value="Breach">Breach</option>
        <option value="Gekko">Gekko</option>
        <option value="Tejo">Tejo</option>
        <option value="Omen">Omen</option>
        <option value="Viper">Viper</option>
        <option value="Brimstone">Brimstone</option>
        <option value="Astra">Astra</option>
        <option value="Clove">Clove</option>
        <option value="Harbor">Harbor</option>
        <option value="Sage">Sage</option>
        <option value="Killjoy">Killjoy</option>
        <option value="Cypher">Cypher</option>
        <option value="Chamber">Chamber</option>
        <option value="Deadlock">Deadlock</option>
        <option value="Vyse">Vyse</option>
      </select>
      <input type="number" placeholder="ACS" class="acs" min="0">
      <input type="number" placeholder="Kills" class="kill" min="0">
      <input type="number" placeholder="Deaths" class="death" min="0">
      <input type="number" placeholder="Assists" class="assist" min="0">
      <input type="number" placeholder="HS%" class="hs" min="0" max="100">
      <input type="number" placeholder="FK" class="fb" min="0">
      <input type="number" placeholder="FD" class="fd" min="0">
      <input type="number" placeholder="MK" class="mk" min="0">
      <input type="number" placeholder="KAST" class="kast" min="0" max="100">
      <input type="number" placeholder="ADR" class="adr" min="0">
      <input type="number" placeholder="DDDelta" class="dddelta" min="0">
    `;
    return row;
  };
  for(let i=0;i<5;i++){ teamA.appendChild(createRow()); teamB.appendChild(createRow()); }
}

// --- NUEVA FUNCIONALIDAD: CARGAR JSON ---
document.getElementById('loadJsonBtn').addEventListener('click', () => {
  let json;
  try { json = JSON.parse(document.getElementById('jsonInput').value); }
  catch (e) { alert('JSON inválido'); return; }

  document.getElementById('matchMap').value = json.map || '';
  document.getElementById('winnerTeam').value = json.winnerTeam==='A'?'A':'B';
  document.getElementById('matchScore').value = json.score || '';

  function fillTeam(teamDiv, teamPlayers){
    const rows = [...teamDiv.querySelectorAll('.team-row')];
    teamPlayers.forEach((p,i)=>{
      if(i>=rows.length) return;
      const row=rows[i];
      row.querySelector('.player-select').value=`${p.name}||${p.tag}`;
      row.querySelector('.character-select').value=p.character||'';
      row.querySelector('.acs').value=p.ACS||0;
      row.querySelector('.kill').value=p.kills||0;
      row.querySelector('.death').value=p.deaths||0;
      row.querySelector('.assist').value=p.assists||0;
      row.querySelector('.hs').value=p.hsPercent||0;
      row.querySelector('.fb').value=p.FK||0;
      row.querySelector('.fd').value=p.FD||0;
      row.querySelector('.mk').value=p.MK||0;
      row.querySelector('.kast').value=p.KAST||0;
      row.querySelector('.adr').value=p.ADR||0;
      row.querySelector('.dddelta').value=p.DDDelta||0;
    });
  }

  fillTeam(document.getElementById('teamA'), json.teamA || []);
  fillTeam(document.getElementById('teamB'), json.teamB || []);
});

// --- Registrar partida (igual que tu código original) ---
document.getElementById('submitMatchBtn').addEventListener('click', async () => {
  const map=document.getElementById('matchMap').value;
  const winnerTeam=document.getElementById('winnerTeam').value;
  const score=document.getElementById('matchScore').value.trim();
  if(!map||!winnerTeam||!score){ alert('Completa todos los campos'); return; }

  const matchPlayers=[];
  [...document.querySelectorAll('#teamA .team-row'), ...document.querySelectorAll('#teamB .team-row')].forEach(row=>{
    const sel=row.querySelector('.player-select'); if(!sel.value) return;
    const [name,tag]=sel.value.split('||');
    const character=row.querySelector('.character-select').value || '';
    matchPlayers.push({
      name, tag, character,
      ACS: parseInt(row.querySelector('.acs').value)||0,
      kills: parseInt(row.querySelector('.kill').value)||0,
      deaths: parseInt(row.querySelector('.death').value)||0,
      assists: parseInt(row.querySelector('.assist').value)||0,
      hsPercent: parseFloat(row.querySelector('.hs').value)||0,
      FK: parseInt(row.querySelector('.fb').value)||0,
      FD: parseInt(row.querySelector('.fd').value)||0,
      MK: parseInt(row.querySelector('.mk').value)||0,
      KAST: parseFloat(row.querySelector('.kast').value)||0,
      ADR: parseFloat(row.querySelector('.adr').value)||0,
      DDDelta: parseFloat(row.querySelector('.dddelta').value)||0
    });
  });

  if(matchPlayers.length!==10){ alert('Selecciona 5 jugadores por equipo'); return; }

  try{
    const res=await fetch('/matches',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ match:matchPlayers, winnerTeam, score, map })
    });
    const data=await res.json();
    if(!res.ok) return alert(data.error||'Error agregando partida');
    document.getElementById('matchAlert').innerText='Partida registrada correctamente';
    setTimeout(()=>document.getElementById('matchAlert').innerText='',2000);
    loadPlayers();
    loadMatches();
  }catch(err){ console.error(err); alert('Error de conexión'); }
});

async function loadMatches(){
  const res = await fetch('/matches',{credentials:'include'});
  allMatches = await res.json();
  const tbody=document.getElementById('matchesTableBody');
  tbody.innerHTML='';
  if(!allMatches.length){ tbody.innerHTML='<tr><td colspan="5">No hay partidas registradas</td></tr>'; return; }

  allMatches.forEach(m=>{
    const row=document.createElement('tr');
    row.innerHTML=`
      <td>${m.map}</td>
      <td>${m.score}</td>
      <td>${m.winnerTeam}</td>
      <td>${new Date(m.date).toLocaleString()}</td>
      <td><button class="btn-delete">Eliminar</button></td>
    `;
    tbody.appendChild(row);
    row.querySelector('.btn-delete').addEventListener('click', async () => {
      if(!confirm('Eliminar partida?')) return;
      const res = await fetch('/matches/'+m._id, { method:'DELETE', credentials:'include' });
      if(!res.ok) return alert((await res.json()).error||'Error eliminando partida');
      loadPlayers();
      loadMatches();
    });
  });
}
</script>

</body>
</html>
