<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel Valorant</title>
<script src="https://unpkg.com/lucide/dist/lucide.min.js"></script>
<style>
   /* ------------------------- */
/* --- Reset y Base --- */
/* ------------------------- */
* { margin:0; padding:0; box-sizing:border-box; font-family:Arial, sans-serif; }
body { display:flex; min-height:100vh; background:#f4f4f4; color:#333; }
button { cursor:pointer; }

/* ------------------------- */
/* --- Sidebar --- */
/* ------------------------- */
.sidebar { width:220px; background:#1a1a1a; color:white; flex-shrink:0; display:flex; flex-direction:column; transition:width 0.3s; }
.sidebar-header { display:flex; justify-content:space-between; align-items:center; padding:1rem; border-bottom:1px solid #333; }
.sidebar-title { font-size:1.2rem; font-weight:bold; display:flex; align-items:center; }
.sidebar-title .valorant-logo { color:#ff4655; margin-right:0.5rem; }
.sidebar-nav { flex:1; display:flex; flex-direction:column; }
.nav-item { display:flex; align-items:center; padding:0.8rem 1rem; text-decoration:none; color:white; transition:0.2s; }
.nav-item i { margin-right:0.5rem; }
.nav-item.active, .nav-item:hover { background:#ff4655; }

/* ------------------------- */
/* --- Main Content --- */
/* ------------------------- */
.main-content { flex:1; padding:1rem 2rem; overflow-y:auto; }
.main-header { margin-bottom:1rem; }
.page-title { font-size:1.5rem; }

/* ------------------------- */
/* --- Dashboard Stats --- */
/* ------------------------- */
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; }
.stat-card { background:white; padding:1rem; border-radius:8px; display:flex; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.stat-icon { font-size:2rem; margin-right:1rem; color:#ff4655; }
.stat-number { font-size:1.5rem; font-weight:bold; display:block; }
.stat-change.positive { color:green; }
.stat-change.neutral { color:#666; }

/* ------------------------- */
/* --- Players Grid --- */
/* ------------------------- */
.players-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-top:1rem; }
.player-card { background:white; padding:0.8rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
.player-card-header { margin-bottom:0.5rem; }
.player-name { font-weight:bold; }
.player-social { margin-bottom:0.5rem; }
.social-icon { margin-right:0.3rem; text-decoration:none; font-weight:bold; color:#ff4655; }
.player-card-actions { display:flex; justify-content:space-between; }

/* ------------------------- */
/* --- Forms --- */
/* ------------------------- */
.form-row { display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem; }
.form-group { flex:1; display:flex; flex-direction:column; margin-bottom:0.5rem; }
label { margin-bottom:0.3rem; font-weight:bold; }
input, select { padding:0.4rem; border:1px solid #ccc; border-radius:4px; }
button.btn { padding:0.5rem 1rem; border:none; border-radius:4px; }
.btn-primary { background:#ff4655; color:white; }
.btn-outline { border:1px solid #ff4655; color:#ff4655; background:none; }
.btn-danger { background:#e74c3c; color:white; }
.btn-sm { font-size:0.8rem; padding:0.3rem 0.6rem; }

/* ------------------------- */
/* --- Modales --- */
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal-content { background:white; padding:1rem; border-radius:8px; width:400px; max-width:90%; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
.modal-close { background:none; border:none; font-size:1.2rem; }
.modal-footer { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.5rem; }

/* ------------------------- */
/* --- Matches Table --- */
.teams-table-container { display:flex; gap:2rem; flex-wrap:wrap; margin-bottom:1rem; }
.team-table { border-collapse:collapse; width:100%; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.team-table th, .team-table td { border:1px solid #ccc; padding:0.5rem; text-align:left; }
.team-table select { width:100%; } 
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2 class="sidebar-title"><span class="valorant-logo">V</span> Admin Panel</h2>
        <button id="sidebarToggle">☰</button>
    </div>
    <nav class="sidebar-nav">
        <a class="nav-item active" data-section="dashboard"><i data-lucide="bar-chart-3"></i><span>Dashboard</span></a>
        <a class="nav-item" data-section="players"><i data-lucide="users"></i><span>Jugadores</span></a>
        <a class="nav-item" data-section="addMatch"><i data-lucide="sword"></i><span>Agregar Partida</span></a>
        <a class="nav-item" data-section="matches"><i data-lucide="list"></i><span>Partidas</span></a>
        <a class="nav-item" id="logoutBtn"><i data-lucide="log-out"></i><span>Cerrar Sesión</span></a>
    </nav>
</aside>

<main class="main-content">
<header class="main-header">
    <h1 class="page-title">Dashboard</h1>
</header>

<!-- Dashboard -->
<section id="dashboard" class="content-section active">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i data-lucide="users"></i></div>
            <div class="stat-content">
                <h3>Total Jugadores</h3>
                <span class="stat-number" id="totalPlayers">0</span>
                <span class="stat-change positive" id="playersChange">+0 este mes</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i data-lucide="sword"></i></div>
            <div class="stat-content">
                <h3>Total Partidas</h3>
                <span class="stat-number" id="totalMatches">0</span>
                <span class="stat-change positive" id="matchesChange">+0 esta semana</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i data-lucide="clock"></i></div>
            <div class="stat-content">
                <h3>Última Partida</h3>
                <span class="stat-number" id="lastMatchDate">N/A</span>
                <span class="stat-change neutral">Actualizado en tiempo real</span>
            </div>
        </div>
    </div>
</section>

<!-- Players Section -->
<section id="players" class="content-section">
<div class="section-header">
    <h2>Gestión de Jugadores</h2>
    <button class="btn btn-primary" id="add-player-btn"><i data-lucide="plus"></i> Agregar Jugador</button>
</div>
<div class="search-bar">
    <input type="text" placeholder="Buscar jugador..." class="search-input" id="playerSearch">
    <i data-lucide="search"></i>
</div>
<div class="players-grid" id="playersGrid"></div>
</section>

<!-- Add Match Section -->
<section id="addMatch" class="content-section">
<div class="section-header"><h2>Agregar Partida</h2></div>
<form class="match-form" id="addMatchForm">
    <div class="form-row">
        <div class="form-group">
            <label>Mapa</label>
            <select id="addMatchMap" required>
                <option value="">Selecciona mapa</option>
                <option>Bind</option><option>Haven</option><option>Split</option>
                <option>Ascent</option><option>Icebox</option><option>Breeze</option>
                <option>Corrode</option><option>Abyss</option><option>Sunset</option>
                <option>Lotus</option><option>Pearl</option><option>Fracture</option>
            </select>
        </div>
        <div class="form-group">
            <label>Ganador</label>
            <select id="addMatchWinner" required>
                <option value="">Seleccionar</option>
                <option value="A">Equipo A</option>
                <option value="B">Equipo B</option>
            </select>
        </div>
        <div class="form-group">
            <label>Marcador final</label>
            <input type="text" id="addMatchScore" placeholder="Ej: 13-8" required>
        </div>
    </div>

    <!-- Tabla de selección de jugadores -->
    <div class="teams-table-container">
        <h3>Equipo A</h3>
        <table class="team-table" id="teamATable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Jugador</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h3>Equipo B</h3>
        <table class="team-table" id="teamBTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Jugador</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="form-actions">
        <button type="button" class="btn btn-outline" id="cancel-match-btn">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Partida</button>
    </div>
    <span id="matchAlert" class="alert hidden"></span>
</form>
</section>

<!-- Matches Section -->
<section id="matches" class="content-section">
<div class="section-header">
    <h2>Partidas</h2>
    <div class="filters">
        <select class="filter-select" id="mapFilter">
            <option value="">Todos los mapas</option>
            <option>Bind</option><option>Haven</option><option>Split</option>
            <option>Ascent</option><option>Icebox</option><option>Breeze</option>
            <option>Corrode</option><option>Abyss</option><option>Sunset</option>
            <option>Lotus</option><option>Pearl</option><option>Fracture</option>
        </select>
        <select class="filter-select" id="dateFilter">
            <option value="all">Todo el tiempo</option>
            <option value="month">Último mes</option>
            <option value="week">Última semana</option>
            <option value="today">Hoy</option>
        </select>
    </div>
</div>
<div class="matches-grid" id="matchesGrid"></div>
</section>

<!-- Modales para Jugadores -->
<div class="modal" id="player-modal">
<div class="modal-content">
    <div class="modal-header">
        <h3 id="playerModalTitle">Agregar Jugador</h3>
        <button class="modal-close" id="cancel-player">&times;</button>
    </div>
    <div class="modal-body">
        <form id="formPlayer">
            <div class="form-group">
                <label>Nombre</label><input type="text" id="playerName" required>
            </div>
            <div class="form-group">
                <label>Tag</label><input type="text" id="playerTag" required>
            </div>
            <div class="form-group">
                <label>Redes Sociales (Opcional)</label>
                <input type="text" id="playerTwitch" placeholder="Twitch URL">
                <input type="text" id="playerTwitter" placeholder="Twitter URL">
                <input type="text" id="playerTracker" placeholder="Valorant Tracker URL">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="cancelPlayerBtn">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

const playersGrid = document.getElementById("playersGrid");
const teamATable = document.querySelector("#teamATable tbody");
const teamBTable = document.querySelector("#teamBTable tbody");
const matchForm = document.getElementById("addMatchForm");
const playerForm = document.getElementById("formPlayer");
const modalPlayer = document.getElementById("player-modal");
const addPlayerBtn = document.getElementById("add-player-btn");

let players = [];

// -------------------
// --- Fetch Players
// -------------------
async function fetchPlayers() {
    try {
        const res = await fetch("/players", { credentials: "include" });
        players = await res.json();
    } catch(e){ console.error(e); players=[]; }
}

// -------------------
// --- Render Players Cards
// -------------------
function renderPlayerCards() {
    playersGrid.innerHTML="";
    players.forEach(p=>{
        const card=document.createElement("div");
        card.className="player-card";
        const social = p.social || {};
        card.innerHTML=`
            <div class="player-card-header">
                <div><div class="player-name">${p.name}</div><div class="player-tag">${p.tag}</div></div>
            </div>
            <div class="player-social">
                ${social.twitch? `<a href="${social.twitch}" target="_blank" class="social-icon">T</a>` : ""}
                ${social.twitter? `<a href="${social.twitter}" target="_blank" class="social-icon">Tw</a>` : ""}
                ${social.tracker? `<a href="${social.tracker}" target="_blank" class="social-icon">VT</a>` : ""}
            </div>
            <div class="player-card-actions">
                <button class="btn btn-outline btn-sm edit-btn">Editar</button>
                <button class="btn btn-danger btn-sm delete-btn">Eliminar</button>
            </div>
        `;
        card.querySelector(".edit-btn").addEventListener("click", ()=>{
            document.getElementById("playerModalTitle").textContent="Editar Jugador";
            modalPlayer.style.display="flex";
            document.getElementById("playerName").value=p.name;
            document.getElementById("playerTag").value=p.tag;
            document.getElementById("playerTwitch").value=social.twitch||"";
            document.getElementById("playerTwitter").value=social.twitter||"";
            document.getElementById("playerTracker").value=social.tracker||"";
        });
        card.querySelector(".delete-btn").addEventListener("click", async ()=>{
            if(!confirm(`Eliminar ${p.name}#${p.tag}?`)) return;
            await fetch("/players",{ method:"DELETE", credentials:"include", headers:{"Content-Type":"application/json"}, body:JSON.stringify({name:p.name,tag:p.tag})});
            await loadPlayers();
        });
        playersGrid.appendChild(card);
    });
}

// -------------------
// --- Render Teams Table
// -------------------
function renderTeamsTable() {
    function createSelect(value="") {
        const sel=document.createElement("select");
        sel.innerHTML=`<option value="">--Selecciona--</option>`+players.map(p=>`<option value="${p.name}#${p.tag}">${p.name}#${p.tag}</option>`).join("");
        sel.value=value;
        return sel;
    }
    teamATable.innerHTML="";
    teamBTable.innerHTML="";
    for(let i=0;i<5;i++){
        let trA=document.createElement("tr");
        let tdA1=document.createElement("td"); tdA1.textContent=i+1;
        let tdA2=document.createElement("td"); tdA2.appendChild(createSelect());
        trA.appendChild(tdA1); trA.appendChild(tdA2); teamATable.appendChild(trA);

        let trB=document.createElement("tr");
        let tdB1=document.createElement("td"); tdB1.textContent=i+1;
        let tdB2=document.createElement("td"); tdB2.appendChild(createSelect());
        trB.appendChild(tdB1); trB.appendChild(tdB2); teamBTable.appendChild(trB);
    }
}

// -------------------
// --- Load Players
// -------------------
async function loadPlayers() {
    await fetchPlayers();
    renderPlayerCards();
    renderTeamsTable();
}

// -------------------
// --- Player Form Submit
// -------------------
playerForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const name=document.getElementById("playerName").value.trim();
    const tag=document.getElementById("playerTag").value.trim();
    const social={
        twitch: document.getElementById("playerTwitch").value.trim(),
        twitter: document.getElementById("playerTwitter").value.trim(),
        tracker: document.getElementById("playerTracker").value.trim()
    };
    const exists = players.find(p=>p.name===name && p.tag===tag);
    const method = exists ? "PUT" : "POST";
    const body = exists ? {oldName:exists.name, oldTag:exists.tag, newName:name, newTag:tag, social} : {name,tag,social};
    await fetch("/players",{method,credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
    modalPlayer.style.display="none";
    playerForm.reset();
    await loadPlayers();
});

// -------------------
// --- Match Form Submit
// -------------------
matchForm.addEventListener("submit", async e=>{
    e.preventDefault();
    function getPlayersFromTable(table){
        const selected=[];
        const options = table.querySelectorAll("select");
        const used = new Set();
        for(const opt of options){
            if(opt.value && !used.has(opt.value)){
                used.add(opt.value);
                const [name,tag] = opt.value.split("#");
                selected.push({name,tag,kills:0,deaths:0,assists:0,acs:0,firstBloods:0,hsPercent:0});
            }
        }
        return selected;
    }
    const teamA = getPlayersFromTable(teamATable);
    const teamB = getPlayersFromTable(teamBTable);
    if(teamA.length===0 || teamB.length===0){ alert("Selecciona al menos un jugador por equipo"); return; }
    const winnerTeam=document.getElementById("addMatchWinner").value;
    const map=document.getElementById("addMatchMap").value;
    const score=document.getElementById("addMatchScore").value.trim();
    const match=[...teamA,...teamB];
    await fetch("/matches",{ method:"POST", credentials:"include", headers:{"Content-Type":"application/json"}, body:JSON.stringify({match,winnerTeam,map,score})});
    matchForm.reset();
    await loadPlayers();
});

// -------------------
// --- Modal
// -------------------
addPlayerBtn.addEventListener("click", ()=>{ modalPlayer.style.display="flex"; document.getElementById("playerModalTitle").textContent="Agregar Jugador"; });
document.getElementById("cancelPlayerBtn").addEventListener("click", ()=>{ modalPlayer.style.display="none"; });
document.getElementById("cancel-player").addEventListener("click", ()=>{ modalPlayer.style.display="none"; });

// -------------------
// --- Initial Load
// -------------------
await loadPlayers();

});
</script>
<script>lucide.replace()</script>
</body>
</html>
