<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin Valorant</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
nav { background:#333; }
nav ul { list-style:none; display:flex; margin:0; padding:0; }
nav li { margin:0; }
nav a { display:block; padding:1rem; color:white; text-decoration:none; }
nav a.active { background:#555; }
main { padding:1rem; }
form.form-inline input, form.form-inline select { margin-right:0.5rem; margin-bottom:0.3rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
section { display:none; }
section.active { display:block; }
.edit-form { background:#f9f9f9; padding:0.5rem; margin-top:0.5rem; border:1px solid #ccc; }
.edit-form input, .edit-form select { margin-right:0.5rem; margin-bottom:0.3rem; }
</style>
</head>
<body>
<header><h1>PANEL DE ADMINISTRADOR</h1></header>
<nav>
  <ul>
    <li><a href="#dashboard" class="active">Dashboard</a></li>
    <li><a href="#players">Gestionar Jugadores</a></li>
    <li><a href="#matches">Partidas</a></li>
    <li><a href="#" id="logoutBtn">Cerrar Sesión</a></li>
  </ul>
</nav>
<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <h2>Dashboard / Resumen</h2>
    <p>Total Jugadores: <span id="totalPlayers">0</span></p>
    <p>Partidas Registradas: <span id="totalMatches">0</span></p>
    <p>Última partida agregada: <span id="lastMatchDate">N/A</span></p>
  </section>

  <!-- JUGADORES -->
  <section id="players">
    <h2>Gestionar Jugadores</h2>
    <form id="addPlayerForm" class="form-inline">
      <input type="text" id="playerName" placeholder="Nombre" required>
      <input type="text" id="playerTag" placeholder="Tag" required>
      <button type="submit">Registrar</button>
    </form>
    <table>
      <thead>
        <tr><th>Nombre</th><th>Tag</th><th>Partidas</th><th>Kills</th><th>Deaths</th><th>Assists</th><th>Acciones</th></tr>
      </thead>
      <tbody id="playersTableBody"><tr><td colspan="7">No hay jugadores registrados</td></tr></tbody>
    </table>
  </section>

  <!-- PARTIDAS -->
  <section id="matches">
    <h2>Partidas</h2>

    <!-- Formulario agregar partida -->
    <div id="addMatchForm" style="margin-bottom:1rem;">
      <label>Mapa:</label>
      <select id="matchMap">
        <option value="">Selecciona mapa</option>
        <option value="Bind">Bind</option>
        <option value="Haven">Haven</option>
        <option value="Split">Split</option>
        <option value="Ascent">Ascent</option>
        <option value="Icebox">Icebox</option>
        <option value="Breeze">Breeze</option>
      </select>

      <label>Ganador:</label>
      <select id="winnerTeam">
        <option value="">Seleccionar</option>
        <option value="A">Equipo A</option>
        <option value="B">Equipo B</option>
      </select>

      <label>Marcador final:</label>
      <input type="text" id="matchScore" placeholder="Ej: 13-8">

      <h4>Equipo A</h4>
      <div id="teamA"></div>

      <h4>Equipo B</h4>
      <div id="teamB"></div>

      <button id="submitMatchBtn">Registrar Partida</button>
    </div>

    <!-- Tabla de partidas -->
    <table>
      <thead>
        <tr>
          <th>Mapa</th>
          <th>Score</th>
          <th>Ganador</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="matchesTableBody">
        <tr><td colspan="5">No hay partidas registradas</td></tr>
      </tbody>
    </table>
  </section>
</main>

<script>
const API_URL = window.location.origin;

// --- Verificar sesión ---
(async ()=>{
  try {
    const res = await fetch('/check-session',{credentials:'include'});
    const data = await res.json();
    if(!data.loggedIn) window.location.href='/login.html';
  } catch { window.location.href='/login.html'; }
})();

// --- Navegación ---
const navLinks = document.querySelectorAll('nav a');
const sections = document.querySelectorAll('section');
navLinks.forEach(link=>{
  link.addEventListener('click', e=>{
    e.preventDefault();
    navLinks.forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    sections.forEach(s=>s.style.display='none');
    document.querySelector(link.getAttribute('href')).style.display='block';
  });
});
sections[0].style.display='block';

// --- Logout ---
document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await fetch('/logout',{method:'POST',credentials:'include'});
  window.location.href='/login.html';
});

// --- CRUD Jugadores ---
let allPlayers=[];
async function loadPlayers(){
  try{
    const res = await fetch('/players',{credentials:'include'});
    allPlayers = await res.json();
    updatePlayersTable();
    populateTeams();
    updateDashboard();
  }catch(err){console.error(err);}
}

function updatePlayersTable(){
  const tbody = document.getElementById('playersTableBody');
  tbody.innerHTML='';
  if(!allPlayers.length){
    tbody.innerHTML='<tr><td colspan="7">No hay jugadores registrados</td></tr>';
    return;
  }
  allPlayers.forEach(p=>{
    const row=document.createElement('tr');
    row.innerHTML=`
      <td>${p.name}</td>
      <td>${p.tag}</td>
      <td>${p.matchesPlayed||0}</td>
      <td>${p.totalKills||0}</td>
      <td>${p.totalDeaths||0}</td>
      <td>${p.totalAssists||0}</td>
      <td>
        <button class="btn-edit">Editar</button>
        <button class="btn-delete">Eliminar</button>
      </td>`;
    tbody.appendChild(row);

    // --- Editar ---
    const editBtn = row.querySelector('.btn-edit');
    const deleteBtn = row.querySelector('.btn-delete');

    const editForm = document.createElement('tr');
    editForm.className='edit-form-row';
    editForm.innerHTML=`<td colspan="7">
      <div class="edit-form" style="display:none;">
        <input type="text" class="edit-name" value="${p.name}" placeholder="Nombre">
        <input type="text" class="edit-tag" value="${p.tag}" placeholder="Tag">
        <input type="text" class="edit-twitter" value="${p.social?.twitter||''}" placeholder="Twitter">
        <input type="text" class="edit-tracker" value="${p.social?.tracker||''}" placeholder="Valorant Tracker">
        <input type="text" class="edit-twitch" value="${p.social?.twitch||''}" placeholder="Twitch">
        <button class="btn-save">Guardar</button>
        <button class="btn-cancel">Cancelar</button>
      </div>
    </td>`;
    row.parentNode.insertBefore(editForm, row.nextSibling);

    const formDiv = editForm.querySelector('.edit-form');
    editBtn.addEventListener('click', ()=> formDiv.style.display = 'block');
    formDiv.querySelector('.btn-cancel').addEventListener('click', ()=> formDiv.style.display = 'none');

    formDiv.querySelector('.btn-save').addEventListener('click', async ()=>{
      const newName = formDiv.querySelector('.edit-name').value.trim();
      const newTag = formDiv.querySelector('.edit-tag').value.trim();
      const twitter = formDiv.querySelector('.edit-twitter').value.trim();
      const tracker = formDiv.querySelector('.edit-tracker').value.trim();
      const twitch = formDiv.querySelector('.edit-twitch').value.trim();
      if(!newName||!newTag) return alert('Nombre y tag requeridos');
      try{
        const res = await fetch('/players',{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({
            oldName:p.name,
            oldTag:p.tag,
            newName,
            newTag,
            social: {twitter, tracker, twitch}
          })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Error al actualizar');
        alert(data.message); loadPlayers();
      }catch(err){alert(err.message);}
    });

    deleteBtn.addEventListener('click', async ()=>{
      if(!confirm('¿Eliminar jugador?')) return;
      try{
        const res = await fetch('/players',{
          method:'DELETE',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({name:p.name, tag:p.tag})
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Error al eliminar');
        alert(data.message); loadPlayers();
      }catch(err){alert(err.message);}
    });
  });
}

// --- Dashboard ---
async function updateDashboard(){
  document.getElementById('totalPlayers').innerText = allPlayers.length;
  try{
    const resMatches = await fetch('/matches-count',{credentials:'include'});
    const dataMatches = await resMatches.json();
    document.getElementById('totalMatches').innerText = dataMatches.count||0;

    const resLast = await fetch('/last-match',{credentials:'include'});
    const dataLast = await resLast.json();
    document.getElementById('lastMatchDate').innerText = dataLast.date ? new Date(dataLast.date).toLocaleString() : "N/A";
  }catch{ 
    document.getElementById('totalMatches').innerText = 0;
    document.getElementById('lastMatchDate').innerText = "N/A";
  }
}

// --- Teams ---
function populateTeams(){
  const teamA = document.getElementById('teamA');
  const teamB = document.getElementById('teamB');
  teamA.innerHTML=''; teamB.innerHTML='';

  const createRow=()=> {
    const row=document.createElement('div');
    row.className='form-inline';
    row.innerHTML=`
      <select class="player-select"><option value="">-- Selecciona jugador --</option>${allPlayers.map(p=>`<option value="${p.name}||${p.tag}">${p.name} (${p.tag})</option>`).join('')}</select>
      <input type="number" placeholder="ACS" class="acs" min="0">
      <input type="number" placeholder="Kills" class="kill" min="0">
      <input type="number" placeholder="Deaths" class="death" min="0">
      <input type="number" placeholder="Assists" class="assist" min="0">
      <input type="number" placeholder="HS%" class="hs" min="0" max="100">
      <input type="number" placeholder="FirstBloods" class="fb" min="0">`;
    return row;
  };

  for(let i=0;i<5;i++){ teamA.appendChild(createRow()); teamB.appendChild(createRow()); }
}

// --- Registrar partida ---
document.getElementById('submitMatchBtn').addEventListener('click', async ()=>{
  const map = document.getElementById('matchMap').value;
  const winnerTeam = document.getElementById('winnerTeam').value;
  const score = document.getElementById('matchScore').value.trim();
  if(!map) return alert('Selecciona mapa');
  if(!winnerTeam) return alert('Selecciona ganador');
  if(!score) return alert('Ingresa marcador final');

  const match=[];
  const teamA = document.getElementById('teamA').querySelectorAll('.form-inline');
  const teamB = document.getElementById('teamB').querySelectorAll('.form-inline');

  for(const row of [...teamA,...teamB]){
    const select=row.querySelector('.player-select'); if(!select.value) continue;
    const [name, tag] = select.value.split('||');
    const acs = parseInt(row.querySelector('.acs').value)||0;
    const kills = parseInt(row.querySelector('.kill').value)||0;
    const deaths = parseInt(row.querySelector('.death').value)||0;
    const assists = parseInt(row.querySelector('.assist').value)||0;
    const hsPercent = parseFloat(row.querySelector('.hs').value)||0;
    const firstBloods = parseInt(row.querySelector('.fb').value)||0;
    match.push({name,tag,acs,kills,deaths,assists,hsPercent,firstBloods});
  }
  if(match.length===0) return alert('No hay jugadores seleccionados');

  try{
    const res = await fetch('/matches',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify({match,winnerTeam,score,map})
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'Error al registrar partida');
    alert(data.message); loadPlayers(); loadMatches();
  }catch(err){alert(err.message);}
});

// --- Añadir jugador ---
document.getElementById('addPlayerForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const name=document.getElementById('playerName').value.trim();
  const tag=document.getElementById('playerTag').value.trim();
  if(!name || !tag) return alert('Nombre y tag requeridos');
  try{
    const res = await fetch('/players',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify({name,tag})
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error||'Error al añadir jugador');
    alert(data.message); e.target.reset(); loadPlayers();
  }catch(err){alert(err.message);}
});

// --- Cargar partidas en tabla ---
async function loadMatches(){
  try{
    const res = await fetch('/matches',{credentials:'include'});
    const matches = await res.json();
    const tbody = document.getElementById('matchesTableBody');
    tbody.innerHTML='';
    if(!matches.length){
      tbody.innerHTML='<tr><td colspan="5">No hay partidas registradas</td></tr>';
      return;
    }
    matches.forEach(m=>{
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${m.map}</td>
        <td>${m.score}</td>
        <td>${m.winnerTeam}</td>
        <td>${new Date(m.date).toLocaleString()}</td>
        <td>
          <button class="btn-edit-match">Editar</button>
        </td>`;
      tbody.appendChild(row);

      const editBtn = row.querySelector('.btn-edit-match');
      editBtn.addEventListener('click', ()=> {
        alert("Editar partida aún requiere implementación de formulario de edición");
      });
    });
  }catch(err){console.error(err);}
}

// --- Inicializar ---
loadPlayers();
loadMatches();
</script>
</body>
</html>
