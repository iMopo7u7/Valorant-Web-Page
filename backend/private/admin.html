<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin Valorant</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
nav { background:#333; }
nav ul { list-style:none; display:flex; margin:0; padding:0; flex-wrap: wrap; }
nav li { margin:0; }
nav a { display:block; padding:1rem; color:white; text-decoration:none; }
nav a.active { background:#555; }
main { padding:1rem; }
form input, form select { margin-right:0.5rem; margin-bottom:0.3rem; padding:0.3rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; background:white; }
table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
section { display:none; }
section.active { display:block; }
.edit-row input { width: 90%; }
.team-row input, .team-row select { margin-right:0.3rem; margin-bottom:0.2rem; width: 80px; }
.alert { color: green; margin-top: 0.5rem; display:block; }
.player-row input, .team-row input, .team-row select { text-align:center; }
</style>
</head>
<body>

<header><h1>PANEL DE ADMINISTRADOR</h1></header>

<nav>
  <ul>
    <li><a href="#dashboard" class="active">Dashboard</a></li>
    <li><a href="#players">Gestionar Jugadores</a></li>
    <li><a href="#addMatch">Agregar Partida</a></li>
    <li><a href="#matches">Partidas</a></li>
    <li><a href="#" id="logoutBtn">Cerrar Sesión</a></li>
  </ul>
</nav>

<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <h2>Dashboard / Resumen</h2>
    <p>Total Jugadores: <span id="totalPlayers">0</span></p>
    <p>Partidas Registradas: <span id="totalMatches">0</span></p>
    <p>Última partida agregada: <span id="lastMatchDate">N/A</span></p>
  </section>

  <!-- GESTIONAR JUGADORES -->
  <section id="players">
    <h2>Gestionar Jugadores</h2>
    <form id="addPlayerForm">
      <input type="text" id="playerName" placeholder="Nombre" required>
      <input type="text" id="playerTag" placeholder="Tag" required>
      <button type="submit">Registrar</button>
      <span id="playerAlert" class="alert"></span>
    </form>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tag</th>
          <th>Partidas</th>
          <th>Kills</th>
          <th>Deaths</th>
          <th>Assists</th>
          <th>ACS</th>
          <th>DDDelta</th>
          <th>ADR</th>
          <th>KAST</th>
          <th>FK</th>
          <th>FD</th>
          <th>MK</th>
          <th>Redes / Avatar</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="playersTableBody">
        <tr><td colspan="15">No hay jugadores registrados</td></tr>
      </tbody>
    </table>
  </section>

  <!-- AGREGAR PARTIDA -->
  <section id="addMatch">
    <h2>Agregar Partida</h2>

    <!-- Textarea para pegar los datos del tracker -->
    <label>Pegar datos Valorant Tracker:</label><br>
    <textarea id="jsonInput" rows="10" style="width:100%" placeholder="Pega aquí el texto del scoreboard"></textarea><br>
    <button id="processJsonBtn">Importar Datos Automáticamente</button>
    <span id="jsonAlert" class="alert"></span>

    <div id="addMatchForm" style="margin-bottom:1rem;">
      <label>Mapa:</label>
      <select id="matchMap">
        <option value="">Selecciona mapa</option>
        <option value="Bind">Bind</option>
        <option value="Haven">Haven</option>
        <option value="Split">Split</option>
        <option value="Ascent">Ascent</option>
        <option value="Icebox">Icebox</option>
        <option value="Breeze">Breeze</option>
        <option value="Corrode">Corrode</option>
        <option value="Abyss">Abyss</option>
        <option value="Sunset">Sunset</option>
        <option value="Lotus">Lotus</option>
        <option value="Pearl">Pearl</option>
        <option value="Fracture">Fracture</option>
      </select>
      <label>Ganador:</label>
      <select id="winnerTeam">
        <option value="">Seleccionar</option>
        <option value="A">Equipo A</option>
        <option value="B">Equipo B</option>
      </select>
      <label>Marcador final:</label>
      <input type="text" id="matchScore" placeholder="Ej: 13-8">

      <h4>Equipo A</h4>
      <div id="teamA"></div>
      <h4>Equipo B</h4>
      <div id="teamB"></div>

      <button id="submitMatchBtn">Registrar Partida</button>
      <span id="matchAlert" class="alert"></span>
    </div>
  </section>

  <!-- PARTIDAS -->
  <section id="matches">
    <h2>Partidas</h2>
    <table>
      <thead>
        <tr>
          <th>Mapa</th>
          <th>Score</th>
          <th>Ganador</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="matchesTableBody">
        <tr><td colspan="5">No hay partidas registradas</td></tr>
      </tbody>
    </table>
  </section>
</main>

<script>
const API_URL = window.location.origin;
let allPlayers = [];
let allMatches = [];

document.addEventListener('DOMContentLoaded', () => {

  const navLinks = document.querySelectorAll('nav a');
  const sections = document.querySelectorAll('section');
  navLinks.forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      navLinks.forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      sections.forEach(s => s.style.display = 'none');
      const target = document.querySelector(link.getAttribute('href'));
      if(target) target.style.display = 'block';
    });
  });
  sections[0].style.display = 'block';

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await fetch('/logout', { method: 'POST', credentials: 'include' });
    window.location.href = '/login.html';
  });

  document.getElementById('addPlayerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('playerName').value.trim();
    const tag = document.getElementById('playerTag').value.trim();
    if(!name || !tag) return alert('Nombre y tag son obligatorios');

    try {
      const res = await fetch('/players', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ name, tag, social:{} })
      });
      const data = await res.json();
      if(!res.ok) return alert(data.error||'Error al agregar jugador');
      document.getElementById('playerName').value = '';
      document.getElementById('playerTag').value = '';
      document.getElementById('playerAlert').innerText = 'Jugador registrado correctamente';
      setTimeout(()=>document.getElementById('playerAlert').innerText='',2000);
      loadPlayers();
    } catch(err){ console.error(err); alert('Error de conexión'); }
  });

  loadPlayers();
  loadMatches();

  // NUEVO: Importación automática del scoreboard
  document.getElementById('processJsonBtn').addEventListener('click', () => {
    const raw = document.getElementById('jsonInput').value;
    if(!raw) return alert('Pega primero los datos del tracker');
    const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);

    // Detectar mapa
    const mapLine = lines.find(l=>["Bind","Haven","Split","Ascent","Icebox","Breeze","Corrode","Abyss","Sunset","Lotus","Pearl","Fracture"].includes(l));
    if(mapLine) document.getElementById('matchMap').value = mapLine;

    // Detectar marcador y ganador
    const idxTeamA = lines.findIndex(l=>"Team A"===l);
    const idxTeamB = lines.findIndex(l=>"Team B"===l);
    if(idxTeamA!==-1 && idxTeamB!==-1){
      const scoreA = parseInt(lines[idxTeamA+1]);
      const scoreB = parseInt(lines[idxTeamB+1]);
      document.getElementById('matchScore').value = `${scoreA}-${scoreB}`;
      document.getElementById('winnerTeam').value = scoreA>scoreB?'A':'B';
    }

    const parsePlayers=(startIdx,teamId)=>{
      const teamRows = document.querySelectorAll(`#${teamId} .team-row`);
      let idx=startIdx;
      let rowCounter=0;
      while(idx<lines.length && rowCounter<5){
        const row = teamRows[rowCounter];
        if(!row) break;

        const name = lines[idx+1] || '';
        const tag = lines[idx+2] || '';
        const char = lines[idx] || '';
        const ACS = parseInt(lines[idx+4]||0);
        const K = parseInt(lines[idx+5]||0);
        const D = parseInt(lines[idx+6]||0);
        const A = parseInt(lines[idx+7]||0);
        const DDDelta = parseInt(lines[idx+9]||0);
        const ADR = parseFloat(lines[idx+10]||0);
        const HS = parseFloat(lines[idx+11]||0);
        const KAST = parseFloat(lines[idx+12]||0);
        const FK = parseInt(lines[idx+13]||0);
        const FD = parseInt(lines[idx+14]||0);
        const MK = parseInt(lines[idx+15]||0);

        // Seleccionar jugador
        const sel = row.querySelector('.player-select');
        for(let i=0;i<sel.options.length;i++){ 
          if(sel.options[i].text.includes(name)){ sel.selectedIndex=i; break; } 
        }

        // Seleccionar personaje
        const charSel = row.querySelector('.character-select');
        for(let i=0;i<charSel.options.length;i++){ 
          if(charSel.options[i].value.toLowerCase()===char.toLowerCase()){ charSel.selectedIndex=i; break; } 
        }

        row.querySelector('.acs').value = ACS;
        row.querySelector('.kill').value = K;
        row.querySelector('.death').value = D;
        row.querySelector('.assist').value = A;
        row.querySelector('.dddelta').value = DDDelta;
        row.querySelector('.adr').value = ADR;
        row.querySelector('.hs').value = HS;
        row.querySelector('.kast').value = KAST;
        row.querySelector('.fb').value = FK;
        row.querySelector('.fd').value = FD;
        row.querySelector('.mk').value = MK;

        idx+=16; rowCounter++;
      }
    };

    parsePlayers(idxTeamA+2,'teamA');
    parsePlayers(idxTeamB+2,'teamB');
    document.getElementById('jsonAlert').innerText='Datos importados automáticamente';
    setTimeout(()=>document.getElementById('jsonAlert').innerText='',2000);
  });
});
