<script>
// Cargar JSON y rellenar inputs
document.getElementById('loadJsonBtn').addEventListener('click', () => {
  let json;
  try { json = JSON.parse(document.getElementById('jsonInput').value); }
  catch (e) { alert('JSON inválido'); return; }

  document.getElementById('matchMap').value = json.map || '';
  document.getElementById('winnerTeam').value = json.winner === 'Team A' ? 'A' : 'B';
  document.getElementById('matchScore').value = json.score || '';

  // Crear filas dinámicas según JSON si no hay suficientes
  function fillTeam(teamDiv, teamPlayers) {
    teamDiv.innerHTML = '';
    teamPlayers.forEach(p => {
      const row = document.createElement('div');
      row.className='team-row';
      row.innerHTML=`
        <select class="player-select"><option value="">-- Selecciona jugador --</option>${allPlayers.map(ap=>`<option value="${ap.name}||${ap.tag}">${ap.name} (${ap.tag})</option>`).join('')}</select>
        <select class="character-select">
          <option value="">-- Personaje --</option>
          <option value="Jett">Jett</option>
          <option value="Reyna">Reyna</option>
          <option value="Phoenix">Phoenix</option>
          <option value="Raze">Raze</option>
          <option value="Yoru">Yoru</option>
          <option value="Neon">Neon</option>
          <option value="Iso">Iso</option>
          <option value="Waylay">Waylay</option>
          <option value="Sova">Sova</option>
          <option value="Skye">Skye</option>
          <option value="KAY/O">KAY/O</option>
          <option value="Fade">Fade</option>
          <option value="Breach">Breach</option>
          <option value="Gekko">Gekko</option>
          <option value="Tejo">Tejo</option>
          <option value="Omen">Omen</option>
          <option value="Viper">Viper</option>
          <option value="Brimstone">Brimstone</option>
          <option value="Astra">Astra</option>
          <option value="Clove">Clove</option>
          <option value="Harbor">Harbor</option>
          <option value="Sage">Sage</option>
          <option value="Killjoy">Killjoy</option>
          <option value="Cypher">Cypher</option>
          <option value="Chamber">Chamber</option>
          <option value="Deadlock">Deadlock</option>
          <option value="Vyse">Vyse</option>
        </select>
        <input type="number" placeholder="ACS" class="acs" min="0">
        <input type="number" placeholder="Kills" class="kill" min="0">
        <input type="number" placeholder="Deaths" class="death" min="0">
        <input type="number" placeholder="Assists" class="assist" min="0">
        <input type="number" placeholder="HS%" class="hs" min="0" max="100">
        <input type="number" placeholder="FK" class="fb" min="0">
        <input type="number" placeholder="FD" class="fd" min="0">
        <input type="number" placeholder="MK" class="mk" min="0">
        <input type="number" placeholder="KAST" class="kast" min="0" max="100">
        <input type="number" placeholder="ADR" class="adr" min="0">
        <input type="number" placeholder="DDDelta" class="dddelta" min="-1000">
      `;
      teamDiv.appendChild(row);
      // Rellenar los datos
      row.querySelector('.player-select').value=`${p.nombre}||${p.tag}`;
      row.querySelector('.character-select').value=p.personaje||'';
      row.querySelector('.acs').value=p.ACS||0;
      row.querySelector('.kill').value=p.K||0;
      row.querySelector('.death').value=p.D||0;
      row.querySelector('.assist').value=p.A||0;
      row.querySelector('.hs').value=p['HS%']||0;
      row.querySelector('.fb').value=p.FK||0;
      row.querySelector('.fd').value=p.FD||0;
      row.querySelector('.mk').value=p.MK||0;
      row.querySelector('.kast').value=p.KAST||0;
      row.querySelector('.adr').value=p.ADR||0;
      row.querySelector('.dddelta').value=p.DDDelta||0;
    });
  }

  fillTeam(document.getElementById('teamA'), json.players.filter(p=>p.equipo==='A'));
  fillTeam(document.getElementById('teamB'), json.players.filter(p=>p.equipo==='B'));
});

// Tu resto del código (loadPlayers, updatePlayersTable, loadMatches, submitMatchBtn) permanece intacto
  // Tu resto del código (loadPlayers, updatePlayersTable, loadMatches, submitMatchBtn) permanece intacto

// Registrar partida
document.getElementById('submitMatchBtn').addEventListener('click', async () => {
  const map = document.getElementById('matchMap').value;
  const winnerTeam = document.getElementById('winnerTeam').value;
  const score = document.getElementById('matchScore').value.trim();
  if (!map || !winnerTeam || !score) { alert('Completa todos los campos'); return; }

  const matchPlayers = [];
  [...document.querySelectorAll('#teamA .team-row'), ...document.querySelectorAll('#teamB .team-row')].forEach(row => {
    const sel = row.querySelector('.player-select'); if (!sel.value) return;
    const [name, tag] = sel.value.split('||');
    const character = row.querySelector('.character-select').value || '';
    matchPlayers.push({
      name, tag, personaje: character,
      ACS: parseInt(row.querySelector('.acs').value) || 0,
      K: parseInt(row.querySelector('.kill').value) || 0,
      D: parseInt(row.querySelector('.death').value) || 0,
      A: parseInt(row.querySelector('.assist').value) || 0,
      'HS%': parseFloat(row.querySelector('.hs').value) || 0,
      FK: parseInt(row.querySelector('.fb').value) || 0,
      FD: parseInt(row.querySelector('.fd').value) || 0,
      MK: parseInt(row.querySelector('.mk').value) || 0,
      KAST: parseFloat(row.querySelector('.kast').value) || 0,
      ADR: parseFloat(row.querySelector('.adr').value) || 0,
      DDDelta: parseFloat(row.querySelector('.dddelta').value) || 0,
      equipo: row.parentElement.id === 'teamA' ? 'A' : 'B'
    });
  });

  if (matchPlayers.length !== 10) { alert('Selecciona 5 jugadores por equipo'); return; }

  try {
    const res = await fetch('/matches', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ match: matchPlayers, winnerTeam, score, map })
    });
    const data = await res.json();
    if (!res.ok) return alert(data.error || 'Error agregando partida');
    document.getElementById('matchAlert').innerText = 'Partida registrada correctamente';
    setTimeout(() => document.getElementById('matchAlert').innerText = '', 2000);
    loadPlayers();
    loadMatches();
  } catch (err) { console.error(err); alert('Error de conexión'); }
});

async function loadMatches() {
  const res = await fetch('/matches', { credentials: 'include' });
  allMatches = await res.json();
  const tbody = document.getElementById('matchesTableBody');
  tbody.innerHTML = '';
  if (!allMatches.length) { tbody.innerHTML = '<tr><td colspan="5">No hay partidas registradas</td></tr>'; return; }

  allMatches.forEach(m => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${m.map}</td>
      <td>${m.score}</td>
      <td>${m.winnerTeam}</td>
      <td>${new Date(m.date).toLocaleString()}</td>
      <td><button class="btn-delete">Eliminar</button></td>
    `;
    tbody.appendChild(row);
    row.querySelector('.btn-delete').addEventListener('click', async () => {
      if (!confirm('Eliminar partida?')) return;
      const res = await fetch('/matches/' + m._id, { method: 'DELETE', credentials: 'include' });
      if (!res.ok) return alert((await res.json()).error || 'Error eliminando partida');
      loadPlayers();
      loadMatches();
    });
  });
}

async function loadPlayers() {
  const res = await fetch('/players', { credentials: 'include' });
  allPlayers = await res.json();
  updatePlayersTable();
  populateTeams();
  updateDashboard();
}

function updatePlayersTable() {
  const tbody = document.getElementById('playersTableBody');
  tbody.innerHTML = '';
  if (!allPlayers.length) { tbody.innerHTML = '<tr><td colspan="15">No hay jugadores registrados</td></tr>'; return; }

  allPlayers.forEach((p, index) => {
    const row = document.createElement('tr');
    row.classList.add('player-row');
    row.innerHTML = `
      <td><input type="text" value="${p.name}" class="edit-name"></td>
      <td><input type="text" value="${p.tag}" class="edit-tag"></td>
      <td>${p.matchesPlayed || 0}</td>
      <td>${p.totalKills || 0}</td>
      <td>${p.totalDeaths || 0}</td>
      <td>${p.totalAssists || 0}</td>
      <td>${p.totalACS || 0}</td>
      <td>${p.totalDDDelta || 0}</td>
      <td>${p.totalADR || 0}</td>
      <td>${p.totalKAST || 0}</td>
      <td>${p.totalFK || 0}</td>
      <td>${p.totalFD || 0}</td>
      <td>${p.totalMK || 0}</td>
      <td>
        <input type="text" placeholder="Tracker" value="${p.social?.tracker || ''}" class="edit-tracker"><br>
        <input type="text" placeholder="Twitter" value="${p.social?.twitter || ''}" class="edit-twitter"><br>
        <input type="text" placeholder="Twitch" value="${p.social?.twitch || ''}" class="edit-twitch"><br>
        <input type="text" placeholder="URL Avatar Discord" value="${p.avatarURL || ''}" class="edit-avatar">
      </td>
      <td>
        <button class="btn-save">Guardar</button>
        <button class="btn-delete">Eliminar</button>
        <span class="alert edit-alert" style="margin-left:5px;color:green;"></span>
      </td>
    `;
    tbody.appendChild(row);

    row.querySelector('.btn-save').addEventListener('click', async () => {
      const newName = row.querySelector('.edit-name').value.trim();
      const newTag = row.querySelector('.edit-tag').value.trim();
      const tracker = row.querySelector('.edit-tracker').value.trim();
      const twitter = row.querySelector('.edit-twitter').value.trim();
      const twitch = row.querySelector('.edit-twitch').value.trim();
      const avatarURL = row.querySelector('.edit-avatar').value.trim();
      if (!newName || !newTag) return alert('Nombre y tag son obligatorios');

      try {
        const res = await fetch('/players', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            oldName: p.name,
            oldTag: p.tag,
            newName,
            newTag,
            social: { tracker, twitter, twitch },
            avatarURL
          })
        });
        if (!res.ok) return alert((await res.json()).error || 'Error actualizando jugador');
        row.querySelector('.edit-alert').innerText = 'Editado correctamente';
        setTimeout(() => row.querySelector('.edit-alert').innerText = '', 2000);
        loadPlayers();
      } catch (err) { console.error(err); alert('Error de conexión'); }
    });

    row.querySelector('.btn-delete').addEventListener('click', async () => {
      if (!confirm(`Eliminar jugador ${p.name}?`)) return;
      const res = await fetch('/players', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name: p.name, tag: p.tag })
      });
      if (!res.ok) return alert((await res.json()).error || 'Error eliminando jugador');
      loadPlayers();
    });
  });
}

async function updateDashboard() {
  document.getElementById('totalPlayers').innerText = allPlayers.length;
  const resMatches = await fetch('/matches-count', { credentials: 'include' });
  const dataMatches = await resMatches.json();
  document.getElementById('totalMatches').innerText = dataMatches.count || 0;
  const resLast = await fetch('/last-match', { credentials: 'include' });
  const last = await resLast.json();
  document.getElementById('lastMatchDate').innerText = last.date ? new Date(last.date).toLocaleString() : 'N/A';
}
</script>

</body>
</html>
