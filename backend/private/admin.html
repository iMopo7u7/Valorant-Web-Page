<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admin Valorant</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
nav { background:#333; }
nav ul { list-style:none; display:flex; margin:0; padding:0; }
nav li { margin:0; }
nav a { display:block; padding:1rem; color:white; text-decoration:none; }
nav a.active { background:#555; }
main { padding:1rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
section { display:none; }
section.active { display:block; }
.edit-form { background:#f9f9f9; padding:0.5rem; margin-top:0.5rem; border:1px solid #ccc; display:none; }
.edit-form input { margin-right:0.5rem; margin-bottom:0.3rem; }
</style>
</head>
<body>

<header><h1>PANEL DE ADMINISTRADOR</h1></header>

<nav>
  <ul>
    <li><a href="#dashboard" class="active">Dashboard</a></li>
    <li><a href="#players">Gestionar Jugadores</a></li>
    <li><a href="#addMatch">Agregar Partida</a></li>
    <li><a href="#matches">Partidas</a></li>
    <li><a href="/events.html">Eventos</a></li>
    <li><a href="#" id="logoutBtn">Cerrar Sesión</a></li>
  </ul>
</nav>

<main>
  <section id="dashboard" class="active">
    <h2>Dashboard / Resumen</h2>
    <p>Total Jugadores: <span id="totalPlayers">0</span></p>
    <p>Partidas Registradas: <span id="totalMatches">0</span></p>
    <p>Última partida agregada: <span id="lastMatchDate">N/A</span></p>
  </section>

  <section id="players">
    <h2>Gestionar Jugadores</h2>
    <form id="addPlayerForm" class="form-inline">
      <input type="text" id="playerName" placeholder="Nombre" required>
      <input type="text" id="playerTag" placeholder="Tag" required>
      <button type="submit">Registrar</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tag</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="playersTableBody">
        <tr><td colspan="3">No hay jugadores registrados</td></tr>
      </tbody>
    </table>
  </section>

</main>

<script>
let allPlayers = [];

// Navegación
document.querySelectorAll('nav a').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('nav a').forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('section').forEach(s => s.style.display='none');
    const target = document.querySelector(link.getAttribute('href'));
    if(target) target.style.display='block';
  });
});
document.querySelectorAll('section')[0].style.display='block';

// Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await fetch('/logout',{method:'POST', credentials:'include'});
  window.location.href = '/login.html';
});

// Cargar jugadores
async function loadPlayers(){
  const res = await fetch('/players',{credentials:'include'});
  allPlayers = await res.json();
  updatePlayersTable();
}

// Actualizar tabla
function updatePlayersTable(){
  const tbody = document.getElementById('playersTableBody');
  tbody.innerHTML = '';
  if(!allPlayers.length){ tbody.innerHTML='<tr><td colspan="3">No hay jugadores registrados</td></tr>'; return; }

  allPlayers.forEach(p=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${p.name}</td>
      <td>${p.tag}</td>
      <td>
        <button class="btn-edit">Editar</button>
        <button class="btn-delete">Eliminar</button>
      </td>`;
    tbody.appendChild(row);

    row.querySelector('.btn-edit').addEventListener('click', ()=> showEditForm(p, row));
    row.querySelector('.btn-delete').addEventListener('click', ()=> deletePlayer(p._id));
  });
}

// Mostrar formulario para editar (inline)
function showEditForm(player, row){
  // Crear fila debajo
  const editRow = document.createElement('tr');
  editRow.classList.add('edit-form-row');
  editRow.innerHTML = `
    <td colspan="3">
      <div class="edit-form">
        <input placeholder="Nombre" value="${player.name}" class="edit-name" required>
        <input placeholder="Tag" value="${player.tag}" class="edit-tag" required>
        <input placeholder="Twitch (opcional)" value="${player.social?.twitch||''}" class="edit-twitch">
        <input placeholder="Twitter (opcional)" value="${player.social?.twitter||''}" class="edit-twitter">
        <input placeholder="Valorant Tracker (opcional)" value="${player.social?.tracker||''}" class="edit-tracker">
        <button class="btn-save">Guardar</button>
        <button class="btn-cancel">Cancelar</button>
      </div>
    </td>`;
  row.after(editRow);

  editRow.querySelector('.btn-cancel').addEventListener('click',()=>editRow.remove());
  editRow.querySelector('.btn-save').addEventListener('click', async ()=>{
    const newName = editRow.querySelector('.edit-name').value.trim();
    const newTag = editRow.querySelector('.edit-tag').value.trim();
    const social = {
      twitch: editRow.querySelector('.edit-twitch').value.trim(),
      twitter: editRow.querySelector('.edit-twitter').value.trim(),
      tracker: editRow.querySelector('.edit-tracker').value.trim()
    };
    if(!newName||!newTag) return alert('Nombre y tag son requeridos');

    const res = await fetch('/players',{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id: player._id, newName, newTag, social })
    });
    const data = await res.json();
    if(!res.ok) return alert(data.error||'Error al actualizar');
    editRow.remove();
    loadPlayers();
  });
}

// Eliminar jugador
async function deletePlayer(playerId){
  const player = allPlayers.find(p=>p._id===playerId);
  if(!player) return;
  if(!confirm(`Eliminar jugador ${player.name}?`)) return;

  const res = await fetch('/players',{
    method:'DELETE',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify({ id: playerId })
  });
  const data = await res.json();
  if(!res.ok) return alert(data.error||'Error al eliminar');
  loadPlayers();
}

// Inicializar
loadPlayers();
</script>

</body>
</html>
