<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eventos / Torneos Valorant</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
  main { padding:1rem; }
  form.form-inline input, form.form-inline select { margin-right:0.5rem; margin-bottom:0.3rem; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; }
  table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
  button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
  #eventMatchesPanel { background:#f9f9f9; padding:0.75rem; border:1px solid #ccc; margin-top:0.75rem; }
  .section-title { margin-top:1rem; }
  .teams { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
  .form-inline { display:flex; flex-wrap:wrap; align-items:center; }
  .row { margin-bottom:0.35rem; }
  .hint { font-size: 0.85rem; color:#666; }
</style>
</head>
<body>

<header><h1>EVENTOS / TORNEOS</h1></header>

<main>
  <div class="form-inline" style="margin-bottom:1rem;">
    <button id="backToAdminBtn">Regresar a Admin</button>
  </div>

  <!-- Crear evento -->
  <div id="createEventForm" class="form-inline" style="margin-bottom:1rem;">
    <input type="text" id="eventName" placeholder="Nombre del evento" required>
    <select id="eventTeamSize">
      <option value="">Tamaño de equipo</option>
      <option value="1">1vs1</option>
      <option value="2">2vs2</option>
      <option value="3">3vs3</option>
      <option value="4">4vs4</option>
      <option value="5">5vs5</option>
    </select>
    <select id="eventNumTeams">
      <option value="">Número de equipos</option>
      <option value="2">2</option>
      <option value="4">4</option>
      <option value="8">8</option>
      <option value="16">16</option>
    </select>
    <button id="createEventBtn">Crear Evento</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Tamaño</th>
        <th># Equipos</th>
        <th>Rondas</th>
        <th>Badge</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="eventsTableBody">
      <tr><td colspan="6">Cargando...</td></tr>
    </tbody>
  </table>

  <div id="eventMatchesPanel" style="display:none;">
    <h3 id="eventMatchesTitle">Partidas del Evento</h3>
    <div id="eventMatchesList" class="hint">No hay partidas aún</div>
  </div>
</main>

<script>
const API_URL = window.location.origin;
let allEvents = [], currentEvent = null;

async function loadEvents(){
  const res = await fetch('/events', {credentials:'include'});
  if(!res.ok){ alert('Error cargando eventos'); return; }
  allEvents = await res.json();
  renderEvents();
}

function renderEvents(){
  const tbody = document.getElementById('eventsTableBody');
  tbody.innerHTML = '';
  if(!allEvents.length){ tbody.innerHTML='<tr><td colspan="6">No hay eventos creados</td></tr>'; return; }

  allEvents.forEach((ev,i)=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${ev.name}</td>
      <td>${ev.teamSize}</td>
      <td>${ev.numTeams}</td>
      <td>${ev.rounds || 0}</td>
      <td>${ev.badge || '-'}</td>
      <td><button class="btn-edit" data-index="${i}">Editar</button></td>
    `;
    tbody.appendChild(row);
  });

  document.querySelectorAll('.btn-edit').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      currentEvent = allEvents[btn.dataset.index];
      const res = await fetch(`/events/${currentEvent._id}/matches`, {credentials:'include'});
      const matches = res.ok ? await res.json() : [];
      document.getElementById('eventMatchesTitle').innerText = `Partidas: ${currentEvent.name}`;
      document.getElementById('eventMatchesList').innerHTML = matches.length ? matches.map((m,i)=>`<div>#${i+1}: ${m.map} | Ganador: ${m.winnerTeam} | Score: ${m.score}</div>`).join('') : 'No hay partidas aún';
      document.getElementById('eventMatchesPanel').style.display = 'block';
    });
  });
}

document.getElementById('createEventBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('eventName').value.trim();
  const teamSize = parseInt(document.getElementById('eventTeamSize').value);
  const numTeams = parseInt(document.getElementById('eventNumTeams').value);
  if(!name || !teamSize || !numTeams){ return alert('Completa todos los campos'); }

  const res = await fetch('/events',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify({name,teamSize,numTeams})
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok) return alert(data.error||'Error creando evento');

  alert('Evento creado. Ahora puedes editarlo.');
  document.getElementById('eventName').value='';
  document.getElementById('eventTeamSize').value='';
  document.getElementById('eventNumTeams').value='';
  await loadEvents();
});

document.getElementById('backToAdminBtn').addEventListener('click',()=>{window.location.href='/admin.html';});

(async function init(){ await loadEvents(); })();
</script>

</body>
</html>
