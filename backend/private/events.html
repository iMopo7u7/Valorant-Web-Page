<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eventos / Torneos Valorant</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
  header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
  main { padding:1rem; max-width:1200px; margin:auto; }
  .form-inline input, .form-inline select { margin-right:0.5rem; margin-bottom:0.3rem; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; background:white; }
  table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
  button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
  #eventMatchesPanel { background:white; padding:0.75rem; border:1px solid #ccc; margin-top:0.75rem; }
  .section-title { margin-top:1rem; font-weight:bold; }
  .teams { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-top:0.5rem; }
  .form-inline { display:flex; flex-wrap:wrap; align-items:center; margin-bottom:0.5rem; }
  .row { margin-bottom:0.35rem; }
  .hint { font-size: 0.85rem; color:#666; }
  .team-row { margin-bottom:0.25rem; display:flex; gap:0.25rem; flex-wrap:wrap; }
  .team-row select, .team-row input { flex:1 1 80px; }
  .btn { padding:0.25rem 0.5rem; }
  .active { background:#d0e6f7; }
  .eliminated { text-decoration: line-through; color:#999; }
</style>
</head>
<body>

<header><h1>EVENTOS / TORNEOS</h1></header>

<main>
  <div class="form-inline">
    <button id="backToAdminBtn">Regresar a Admin</button>
  </div>

  <!-- Crear evento -->
  <div id="createEventForm" class="form-inline">
    <input type="text" id="eventName" placeholder="Nombre del evento">
    <select id="eventBadge">
      <option value="">Selecciona Badge</option>
      <option value="champion">Champion ðŸ‘‘</option>
      <option value="finalist">Finalist ðŸ¥ˆ</option>
      <option value="semifinalist">Semifinalist ðŸ¥‰</option>
      <option value="participant">Participant ðŸŽ¯</option>
    </select>
    <select id="eventTeamSize">
      <option value="">TamaÃ±o de equipo</option>
      <option value="1">1vs1</option>
      <option value="2">2vs2</option>
      <option value="3">3vs3</option>
      <option value="4">4vs4</option>
      <option value="5">5vs5</option>
    </select>
    <select id="eventNumTeams">
      <option value="">NÃºmero de equipos</option>
      <option value="2">2</option>
      <option value="4">4</option>
      <option value="8">8</option>
      <option value="16">16</option>
    </select>
    <button id="createEventBtn">Crear Evento</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Equipo / Jugadores</th>
        <th># Equipos</th>
        <th># Partidas</th>
        <th>Badge</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="eventsTableBody">
      <tr><td colspan="6">Cargando...</td></tr>
    </tbody>
  </table>

  <div id="eventMatchesPanel" style="display:none;">
    <h3 id="eventMatchesTitle">Partidas del Evento</h3>

    <h4 class="section-title">Equipos y Jugadores</h4>
    <div id="teamsContainer" class="teams"></div>
    <button id="saveTeamsBtn" class="btn">Guardar Equipos</button>

    <h4 class="section-title">Partidas</h4>
    <div id="matchesContainer"></div>
  </div>
</main>

<script>
const API_URL = window.location.origin;
let allEvents=[], allPlayers=[], currentEvent=null;

// --- Utils ---
function sanitizeInt(n){ const x=parseInt(n,10); return Number.isFinite(x)?x:0; }
function getBadgeIcon(type){
  switch(type){ case 'champion': return 'ðŸ‘‘'; case 'finalist': return 'ðŸ¥ˆ'; case 'semifinalist': return 'ðŸ¥‰'; case 'participant': return 'ðŸŽ¯'; default: return type; }
}

// --- Load players ---
async function loadPlayers(){
  const res = await fetch('/players',{credentials:'include'});
  allPlayers = res.ok? await res.json() : [];
}

// --- Load events ---
async function loadEvents(){
  const res = await fetch('/events',{credentials:'include'});
  allEvents = res.ok? await res.json() : [];
  renderEvents();
}

// --- Render events table ---
function renderEvents(){
  const tbody=document.getElementById('eventsTableBody');
  tbody.innerHTML='';
  if(!allEvents.length){ tbody.innerHTML='<tr><td colspan="6">No hay eventos creados</td></tr>'; return; }
  allEvents.forEach((ev,i)=>{
    const row=document.createElement('tr');
    row.innerHTML=`
      <td>${ev.name}</td>
      <td>${ev.teamSize}vs${ev.teamSize}</td>
      <td>${ev.numTeams}</td>
      <td>${ev.matches.length||0}</td>
      <td>${getBadgeIcon(ev.badge)}</td>
      <td><button class="btn-view" data-index="${i}">Ver / Editar</button></td>
    `;
    tbody.appendChild(row);
  });

  document.querySelectorAll('.btn-view').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.btn-view').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentEvent = allEvents[btn.dataset.index];
      renderTeamsForm();
      renderMatches();
      document.getElementById('eventMatchesPanel').style.display='block';
    });
  });
}

// --- Create event ---
document.getElementById('createEventBtn').addEventListener('click',async()=>{
  const name=document.getElementById('eventName').value.trim();
  const teamSize=parseInt(document.getElementById('eventTeamSize').value);
  const numTeams=parseInt(document.getElementById('eventNumTeams').value);
  const badge=document.getElementById('eventBadge').value;
  if(!name || !teamSize || !numTeams){ return alert('Completa todos los campos'); }

  const eventTeams={};
  for(let i=0;i<numTeams;i++){ eventTeams[String.fromCharCode(65+i)] = []; }

  const res = await fetch('/events',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({name,teamSize,numTeams,badge,teams:eventTeams,matches:[]})
  });
  if(!res.ok) return alert('Error creando evento');
  alert('Evento creado');
  loadEvents();
});

// --- Render teams for editing ---
function renderTeamsForm(){
  const container = document.getElementById('teamsContainer');
  container.innerHTML='';
  if(!currentEvent) return;
  Object.keys(currentEvent.teams).forEach(teamKey=>{
    const div = document.createElement('div');
    div.innerHTML=`<h5>Equipo ${teamKey}</h5>`;
    for(let i=0;i<currentEvent.teamSize;i++){
      const row = document.createElement('div');
      row.className='team-row';
      const select = document.createElement('select');
      select.innerHTML='<option value="">Selecciona jugador</option>'+allPlayers.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
      row.appendChild(select);
      div.appendChild(row);
    }
    container.appendChild(div);
  });
}

// --- Save teams ---
document.getElementById('saveTeamsBtn').addEventListener('click',async()=>{
  const teams = {};
  const container = document.getElementById('teamsContainer');
  Array.from(container.children).forEach(div=>{
    const teamKey = div.querySelector('h5').innerText.split(' ')[1];
    teams[teamKey] = Array.from(div.querySelectorAll('select')).map(s=>({name:s.value})).filter(p=>p.name);
  });
  currentEvent.teams = teams;

  const res = await fetch(`/events/${currentEvent._id}`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({teams})
  });
  if(!res.ok) return alert('Error guardando equipos');
  alert('Equipos guardados');
  renderMatches();
});

// --- Generate matches ---
function generateMatches(){
  const aliveTeams = Object.keys(currentEvent.teams).filter(k=>currentEvent.teams[k].length>0);
  const maxMatches = aliveTeams.length - 1;
  const matches = currentEvent.matches || [];
  if(matches.length >= maxMatches) return; // ya completado
  const newMatches = [];
  for(let i=0;i<aliveTeams.length;i+=2){
    if(aliveTeams[i+1]) newMatches.push({teamA: currentEvent.teams[aliveTeams[i]], teamB: currentEvent.teams[aliveTeams[i+1]], winnerTeam:'', map:'', score:'', stats:{}}); 
  }
  return newMatches;
}

// --- Render matches ---
function renderMatches(){
  const container = document.getElementById('matchesContainer');
  container.innerHTML='';
  if(!currentEvent) return;
  const newMatches = generateMatches() || [];
  newMatches.forEach((m,idx)=>{
    const div = document.createElement('div');
    div.style.border='1px solid #ccc'; div.style.margin='4px'; div.style.padding='4px';
    div.innerHTML=`<h5>Partida #${idx+1}</h5>`;
    const mapSelect = document.createElement('select');
    mapSelect.innerHTML=`<option value="">Selecciona mapa</option>
      <option>Bind</option><option>Haven</option><option>Split</option><option>Ascent</option><option>Icebox</option><option>Breeze</option>`;
    div.appendChild(mapSelect);
    const winnerSelect = document.createElement('select');
    winnerSelect.innerHTML='<option value="">Ganador</option><option value="A">Equipo A</option><option value="B">Equipo B</option>';
    div.appendChild(winnerSelect);
    const scoreInput = document.createElement('input'); scoreInput.placeholder='Score'; div.appendChild(scoreInput);

    // Stats por jugador
    ['A','B'].forEach(teamLabel=>{
      const teamDiv = document.createElement('div');
      teamDiv.innerHTML=`<strong>Equipo ${teamLabel}</strong>`;
      const team = teamLabel==='A'? m.teamA : m.teamB;
      team.forEach(p=>{
        const pRow = document.createElement('div');
        pRow.className='team-row';
        pRow.innerHTML=`
          <input type="text" value="${p.name}" disabled>
          <input type="number" placeholder="Kills" min="0">
          <input type="number" placeholder="Deaths" min="0">
          <input type="number" placeholder="Assists" min="0">
          <input type="number" placeholder="ACS" min="0">
          <input type="number" placeholder="HS%" min="0">
          <input type="number" placeholder="FirstBloods" min="0">
        `;
        teamDiv.appendChild(pRow);
      });
      div.appendChild(teamDiv);
    });

    const saveBtn = document.createElement('button');
    saveBtn.innerText='Registrar Partida';
    saveBtn.addEventListener('click',async ()=>{
      const map=mapSelect.value;
      const winner=winnerSelect.value;
      const score=scoreInput.value;
      if(!map || !winner || !score) return alert('Completa mapa, ganador y score');

      // Recoger stats
      ['A','B'].forEach(teamLabel=>{
        const team = teamLabel==='A'? m.teamA : m.teamB;
        team.forEach((p,pi)=>{
          const row = div.querySelectorAll('.team-row')[pi + (teamLabel==='B'? m.teamA.length:0)];
          p.kills=sanitizeInt(row.children[1].value);
          p.deaths=sanitizeInt(row.children[2].value);
          p.assists=sanitizeInt(row.children[3].value);
          p.acs=sanitizeInt(row.children[4].value);
          p.hsPercent=sanitizeInt(row.children[5].value);
          p.firstBloods=sanitizeInt(row.children[6].value);
        });
      });

      m.map=map; m.winnerTeam=winner; m.score=score;

      // Guardar match
      const res = await fetch(`/events/${currentEvent._id}/matches`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        credentials:'include', body:JSON.stringify(m)
      });
      if(!res.ok) return alert('Error registrando partida');
      alert('Partida registrada');
      currentEvent.matches.push(m);
      renderMatches();
    });
    div.appendChild(saveBtn);
    container.appendChild(div);
  });
}

// --- Back to admin ---
document.getElementById('backToAdminBtn').addEventListener('click',()=>{window.location.href='/admin.html';});

// --- Init ---
(async function init(){ await loadPlayers(); await loadEvents(); })();
</script>

</body>
</html>
