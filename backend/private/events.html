<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŽ¯ Valorant Tournament Manager</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ðŸŽ¯ Valorant Tournament Manager</h1>
        <p>Administra torneos profesionales de Valorant con facilidad</p>
    </div>

    <!-- Crear Evento -->
    <div class="section">
        <h2>Crear Nuevo Evento</h2>
        <form id="eventForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="eventName">Nombre del Evento</label>
                    <input type="text" id="eventName" required placeholder="Ej: VCT Masters Madrid">
                </div>
                <div class="form-group">
                    <label for="eventBadge">Badge</label>
                    <select id="eventBadge" required>
                        <option value="Champion">Champion</option>
                        <option value="Finalist">Finalist</option>
                        <option value="Semifinalist">Semifinalist</option>
                        <option value="Participant">Participant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="teamSize">TamaÃ±o de Equipo</label>
                    <select id="teamSize" required>
                        <option value="1vs1">1vs1</option>
                        <option value="2vs2">2vs2</option>
                        <option value="3vs3">3vs3</option>
                        <option value="4vs4">4vs4</option>
                        <option value="5vs5">5vs5</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="numTeams">NÃºmero de Equipos</label>
                    <select id="numTeams" required>
                        <option value="2">2</option>
                        <option value="4">4</option>
                        <option value="8">8</option>
                        <option value="16">16</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn">Crear Evento</button>
        </form>
    </div>

    <!-- Lista de Eventos -->
    <div class="section">
        <h2>Eventos Creados</h2>
        <table id="eventsTable">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>TamaÃ±o de Equipo</th>
                    <th># Equipos</th>
                    <th># Partidas</th>
                    <th>Badge</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Detalles del Evento -->
    <div id="eventDetails" class="event-details" style="display:none;">
        <div class="section">
            <h2 id="eventTitle">Detalles del Evento</h2>
            <div class="tabs">
                <button class="tab active" onclick="showTab(event,'teams')">Equipos</button>
                <button class="tab" onclick="showTab(event,'matches')">Partidas</button>
            </div>

            <!-- Tab Equipos -->
            <div id="teamsTab" class="tab-content active">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="saveTeams()">Guardar Equipos</button>
                </div>
                <div id="teamsContainer" class="teams-grid"></div>
            </div>

            <!-- Tab Partidas -->
            <div id="matchesTab" class="tab-content">
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="createNewMatch()">Crear Nueva Partida</button>
                </div>
                <div id="matchesContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
let events = [];
let currentEventId = null;
let playerNames = [];
const maps = ['Bind','Haven','Split','Ascent','Icebox','Breeze','Fracture','Pearl','Lotus'];

// --------------------
// --- CARGAR JUGADORES DESDE BACKEND
// --------------------
async function loadPlayers() {
    try {
        const res = await fetch('/players', { credentials: 'include' });
        const players = await res.json();
        playerNames = players.map(p => p.name);
    } catch (err) {
        console.error(err);
        alert('Error cargando jugadores');
    }
}

// --------------------
// --- CARGAR EVENTOS DESDE BACKEND
// --------------------
async function loadEvents() {
    try {
        const res = await fetch('/events', { credentials: 'include' });
        events = await res.json();
        updateEventsTable();
    } catch (err) {
        console.error(err);
        alert('Error cargando eventos');
    }
}

// --------------------
// --- CREAR EVENTO
// --------------------
document.getElementById('eventForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('eventName').value;
    const badge = document.getElementById('eventBadge').value;
    const teamSize = document.getElementById('teamSize').value;
    const numTeams = parseInt(document.getElementById('numTeams').value);

    const teams = {};
    for (let i=1; i<=numTeams; i++){
        teams[i] = {name:`Equipo ${i}`, players:[]};
    }

    try {
        const res = await fetch('/events', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify({name, badge, teamSize, numTeams, teams})
        });
        const data = await res.json();
        if(res.ok){
            loadEvents();
            e.target.reset();
        }else{
            alert(data.error);
        }
    } catch(err){
        console.error(err);
        alert('Error creando evento');
    }
});

// --------------------
// --- ACTUALIZAR TABLA DE EVENTOS
// --------------------
function updateEventsTable() {
    const tbody = document.querySelector('#eventsTable tbody');
    tbody.innerHTML = '';
    events.forEach(event=>{
        const row = document.createElement('tr');
        row.innerHTML=`
            <td>${event.name}</td>
            <td>${event.teamSize}</td>
            <td>${event.numTeams}</td>
            <td>${event.matches ? event.matches.length : 0}</td>
            <td><span class="badge badge-${event.badge.toLowerCase()}">${event.badge}</span></td>
            <td>
                <button class="btn btn-secondary" onclick="selectEvent('${event._id}')">Gestionar</button>
                <button class="btn btn-danger" onclick="deleteEvent('${event._id}')">Eliminar</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// --------------------
// --- SELECCIONAR EVENTO
// --------------------
function selectEvent(id){
    currentEventId = id;
    const event = events.find(e=>e._id===id);
    document.getElementById('eventTitle').textContent = `Gestionando: ${event.name}`;
    document.getElementById('eventDetails').style.display='block';
    updateTeamsDisplay();
    updateMatchesDisplay();
}

// --------------------
// --- ELIMINAR EVENTO
// --------------------
async function deleteEvent(id){
    if(!confirm('Â¿Seguro que quieres eliminar este evento?')) return;
    try{
        const res = await fetch(`/events/${id}`, {method:'DELETE', credentials:'include'});
        const data = await res.json();
        if(res.ok) loadEvents();
        else alert(data.error);
    }catch(err){console.error(err);}
}

// --------------------
// --- MOSTRAR TABS
// --------------------
function showTab(e, tabName){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    e.currentTarget.classList.add('active');
    document.getElementById(tabName+'Tab').classList.add('active');
}

// --------------------
// --- EQUIPOS
// --------------------
function updateTeamsDisplay(){
    const event = events.find(e=>e._id===currentEventId);
    const container = document.getElementById('teamsContainer');
    container.innerHTML='';
    Object.values(event.teams).forEach(team=>{
        const teamCard = document.createElement('div');
        teamCard.className='team-card';
        let playersHTML='';
        const playersPerTeam = parseInt(event.teamSize.split('vs')[0]);
        for(let i=0;i<playersPerTeam;i++){
            playersHTML+=`
                <div class="player-assignment">
                    <label>Jugador ${i+1}:</label>
                    <select onchange="updatePlayer('${team.name}',${i},this.value)">
                        <option value="">Seleccionar jugador</option>
                        ${playerNames.map(name=>`<option value="${name}" ${team.players[i]===name?'selected':''}>${name}</option>`).join('')}
                    </select>
                </div>
            `;
        }
        teamCard.innerHTML=`<h4>${team.name}</h4>${playersHTML}`;
        container.appendChild(teamCard);
    });
}

function updatePlayer(teamName, index, playerName){
    const event = events.find(e=>e._id===currentEventId);
    event.teams[teamName].players[index]=playerName;
}

// --------------------
// --- GUARDAR EQUIPOS
// --------------------
async function saveTeams(){
    const event = events.find(e=>e._id===currentEventId);
    try{
        const res = await fetch(`/events/${currentEventId}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify({teams:event.teams})
        });
        const data = await res.json();
        if(res.ok) alert('Equipos guardados correctamente');
        else alert(data.error);
    }catch(err){console.error(err);}
}

// --------------------
// --- PARTIDAS
// --------------------
function updateMatchesDisplay(){
    const event = events.find(e=>e._id===currentEventId);
    const container = document.getElementById('matchesContainer');
    container.innerHTML='';
    if(!event.matches) return;
    event.matches.forEach((match,i)=>{
        const matchCard=document.createElement('div');
        matchCard.className='match-card';
        matchCard.innerHTML=`
            <div class="match-header">
                <div class="match-teams">${match.teamA || 'Equipo A'} vs ${match.teamB || 'Equipo B'}</div>
                <div style="text-align:right;"><div>Partida #${i+1}</div></div>
            </div>
        `;
        container.appendChild(matchCard);
    });
}

function createNewMatch(){
    alert('FunciÃ³n de creaciÃ³n de partida disponible en backend vÃ­a POST /events/:id/matches');
}

// --------------------
// --- INICIALIZACIÃ“N
// --------------------
window.addEventListener('load', async ()=>{
    await loadPlayers();
    await loadEvents();
});
</script>
</body>
</html>
