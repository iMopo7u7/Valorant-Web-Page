<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eventos / Torneos Valorant</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4;}
  header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
  main { padding:1rem; max-width:1200px; margin:auto; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; background:white;}
  th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
  button { padding:0.4rem 0.8rem; margin:0.2rem; cursor:pointer; }
  .form-inline { display:flex; flex-wrap:wrap; align-items:center; gap:0.5rem; margin-bottom:0.5rem; }
  input, select { padding:0.3rem; }
  #eventMatchesPanel { display:none; background:white; padding:1rem; border:1px solid #ccc; margin-top:1rem; }
  .team-container { border:1px solid #ccc; padding:0.5rem; margin-bottom:0.5rem; background:#fafafa; }
  .player-row { display:flex; gap:0.3rem; margin-bottom:0.3rem; align-items:center; flex-wrap:wrap;}
  .player-row input { width:70px; }
  .hint { font-size:0.85rem; color:#666; }
  .section-title { margin-top:1rem; font-weight:bold; }
  .disabled { opacity:0.5; pointer-events:none; }
</style>
</head>
<body>

<header><h1>EVENTOS / TORNEOS</h1></header>

<main>
  <button id="backToAdminBtn">‚Üê Regresar a Admin</button>

  <h2>Crear Evento</h2>
  <div class="form-inline">
    <input type="text" id="eventName" placeholder="Nombre del evento">
    <select id="eventBadge">
      <option value="">Badge</option>
      <option value="champion">Champion üëë</option>
      <option value="finalist">Finalist ü•à</option>
      <option value="semifinalist">Semifinalist ü•â</option>
      <option value="participant">Participant üéØ</option>
    </select>
    <select id="eventTeamSize">
      <option value="">Tama√±o de equipo</option>
      <option value="1">1vs1</option>
      <option value="2">2vs2</option>
      <option value="3">3vs3</option>
      <option value="4">4vs4</option>
      <option value="5">5vs5</option>
    </select>
    <select id="eventNumTeams">
      <option value="">N√∫mero de equipos</option>
      <option value="2">2</option>
      <option value="4">4</option>
      <option value="8">8</option>
      <option value="16">16</option>
    </select>
    <button id="createEventBtn">Crear Evento</button>
  </div>

  <h2>Eventos Existentes</h2>
  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>TeamSize</th>
        <th># Equipos</th>
        <th># Partidas</th>
        <th>Badge</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="eventsTableBody">
      <tr><td colspan="6">Cargando...</td></tr>
    </tbody>
  </table>

  <!-- Panel de partidas -->
  <div id="eventMatchesPanel">
    <h3 id="eventMatchesTitle">Partidas del Evento</h3>

    <div id="eventMatchesList" class="hint">No hay partidas a√∫n</div>

    <h4 class="section-title">Agregar Partida</h4>
    <div id="addEventMatchForm">
      <div class="form-inline">
        <label>Mapa:</label>
        <select id="eventMatchMap">
          <option value="">Selecciona mapa</option>
          <option>Bind</option><option>Haven</option><option>Split</option>
          <option>Ascent</option><option>Icebox</option><option>Breeze</option>
          <option>Corrode</option><option>Abyss</option><option>Sunset</option>
          <option>Lotus</option><option>Pearl</option><option>Fracture</option>
        </select>

        <label>Ganador:</label>
        <select id="eventWinnerTeam">
          <option value="">Seleccionar</option>
          <option value="A">Equipo A</option>
          <option value="B">Equipo B</option>
        </select>

        <label>Marcador:</label>
        <input type="text" id="eventMatchScore" placeholder="Ej: 13-8">
      </div>

      <div class="teams" style="display:flex; gap:1rem;">
        <div class="team-container">
          <h5>Equipo A</h5>
          <div id="eventTeamA" class="team-players"></div>
        </div>
        <div class="team-container">
          <h5>Equipo B</h5>
          <div id="eventTeamB" class="team-players"></div>
        </div>
      </div>

      <div class="hint">
        Selecciona jugadores de la lista y completa sus estad√≠sticas.
      </div>

      <button id="submitEventMatchBtn">Registrar Partida</button>
      <button id="closeEventMatchesBtn" style="float:right;">Cerrar</button>
    </div>
  </div>
</main>

<script>
const API_URL = window.location.origin;
let allPlayers = [], allEvents = [], currentEvent = null, currentTeamSize = 5;

// Utils
function sanitizeInt(v){ const n=parseInt(v,10); return isNaN(n)?0:n; }

// --- Load players
async function loadPlayers(){
  const res = await fetch('/players',{credentials:'include'});
  allPlayers = res.ok ? await res.json() : [];
}

// --- Load events
async function loadEvents(){
  const res = await fetch('/events',{credentials:'include'});
  allEvents = res.ok ? await res.json() : [];
  renderEvents();
}

// --- Badge icons
function getBadgeIcon(b){ switch(b){ case 'champion': return 'üëë'; case 'finalist': return 'ü•à'; case 'semifinalist': return 'ü•â'; case 'participant': return 'üéØ'; default: return b; }}

// --- Render events table
function renderEvents(){
  const tbody = document.getElementById('eventsTableBody');
  tbody.innerHTML = '';
  if(!allEvents.length){ tbody.innerHTML='<tr><td colspan="6">No hay eventos</td></tr>'; return;}
  allEvents.forEach((ev,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${ev.name}</td>
      <td>${ev.teamSize}vs${ev.teamSize}</td>
      <td>${ev.numTeams}</td>
      <td>${ev.matches.length||0}</td>
      <td>${getBadgeIcon(ev.badge)}</td>
      <td><button class="btn-view" data-index="${i}">Ver / Editar</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.btn-view').forEach(btn=>{
    btn.onclick=()=>openEvent(parseInt(btn.dataset.index));
  });
}

// --- Open event panel
function openEvent(idx){
  currentEvent = allEvents[idx];
  currentTeamSize = parseInt(currentEvent.teamSize,10);
  document.getElementById('eventMatchesTitle').innerText = `Partidas: ${currentEvent.name}`;
  renderEventMatchesList();
  populateEventTeams();
  document.getElementById('eventMatchesPanel').style.display='block';
}

// --- Render matches
function renderEventMatchesList(){
  const list = document.getElementById('eventMatchesList');
  const matches = currentEvent.matches || [];
  if(!matches.length){ list.innerHTML='No hay partidas a√∫n'; return;}
  list.innerHTML = matches.map((m,i)=>`#${i+1}: ${m.teamA.map(p=>p.name).join(',')} vs ${m.teamB.map(p=>p.name).join(',')} | ${m.map} | Ganador: ${m.winnerTeam} | Score: ${m.score}`).join('<br>');
}

// --- Create event
document.getElementById('createEventBtn').onclick=async ()=>{
  const name=document.getElementById('eventName').value.trim();
  const badge=document.getElementById('eventBadge').value;
  const teamSize=parseInt(document.getElementById('eventTeamSize').value);
  const numTeams=parseInt(document.getElementById('eventNumTeams').value);
  if(!name||!badge||!teamSize||!numTeams){ return alert('Completa todos los campos'); }
  const teams={};
  for(let i=0;i<numTeams;i++){ teams[String.fromCharCode(65+i)] = []; }
  const res = await fetch('/events',{method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({name,teamSize,numTeams,badge,teams,matches:[]})});
  if(!res.ok) return alert('Error creando evento');
  alert('Evento creado');
  document.getElementById('eventName').value=''; document.getElementById('eventBadge').value=''; document.getElementById('eventTeamSize').value=''; document.getElementById('eventNumTeams').value='';
  loadEvents();
}

// --- Populate teams
function populateEventTeams(){
  ['A','B'].forEach((label)=>{
    const container = document.getElementById(label==='A'?'eventTeamA':'eventTeamB');
    container.innerHTML='';
    const teamKey = Object.keys(currentEvent.teams)[label==='A'?0:1];
    const teamPlayers = currentEvent.teams[teamKey] || [];
    for(let i=0;i<currentTeamSize;i++){
      const playerRow = document.createElement('div');
      playerRow.className='player-row';
      const select = document.createElement('select');
      select.innerHTML = `<option value="">Selecciona jugador</option>`+allPlayers.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
      const kills = document.createElement('input'); kills.placeholder='Kills'; kills.type='number'; kills.min=0;
      const deaths = document.createElement('input'); deaths.placeholder='Deaths'; deaths.type='number'; deaths.min=0;
      const assists = document.createElement('input'); assists.placeholder='Assists'; assists.type='number'; assists.min=0;
      const acs = document.createElement('input'); acs.placeholder='ACS'; acs.type='number'; acs.min=0;
      const hs = document.createElement('input'); hs.placeholder='HS%'; hs.type='number'; hs.min=0; hs.max=100;
      const fb = document.createElement('input'); fb.placeholder='FB'; fb.type='number'; fb.min=0;
      playerRow.append(select,kills,deaths,assists,acs,hs,fb);
      container.appendChild(playerRow);
    }
  });
}

// --- Submit match
document.getElementById('submitEventMatchBtn').onclick=async ()=>{
  if(!currentEvent) return;
  const map=document.getElementById('eventMatchMap').value;
  const winnerTeam=document.getElementById('eventWinnerTeam').value;
  const score=document.getElementById('eventMatchScore').value.trim();
  if(!map||!winnerTeam||!score) return alert('Completa todos los campos');

  const teams = {};
  let valid=true;
  ['A','B'].forEach(label=>{
    const container = document.getElementById(label==='A'?'eventTeamA':'eventTeamB');
    teams[label] = [...container.querySelectorAll('.player-row')].map(row=>{
      const name=row.querySelector('select').value;
      if(!name) valid=false;
      return {
        name,
        kills: sanitizeInt(row.querySelector('[placeholder=Kills]').value),
        deaths: sanitizeInt(row.querySelector('[placeholder=Deaths]').value),
        assists: sanitizeInt(row.querySelector('[placeholder=Assists]').value),
        acs: sanitizeInt(row.querySelector('[placeholder=ACS]').value),
        hsPercent: sanitizeInt(row.querySelector('[placeholder="HS%"]').value),
        firstBloods: sanitizeInt(row.querySelector('[placeholder=FB]').value)
      }
    });
  });
  if(!valid) return alert('Selecciona todos los jugadores');

  const match={map,winnerTeam,score,teamA:teams.A,teamB:teams.B};
  const res = await fetch(`/events/${currentEvent._id}/matches`,{method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(match)});
  if(!res.ok) return alert('Error agregando partida');

  alert('Partida registrada');
  currentEvent.matches.push(match);
  renderEventMatchesList();
  populateEventTeams();
  document.getElementById('eventMatchMap').value=''; document.getElementById('eventWinnerTeam').value=''; document.getElementById('eventMatchScore').value='';
}

// --- Close panel
document.getElementById('closeEventMatchesBtn').onclick=()=>{
  document.getElementById('eventMatchesPanel').style.display='none';
  currentEvent=null;
}

// --- Back to admin
document.getElementById('backToAdminBtn').onclick=()=>window.location.href='/admin.html';

// --- Init
(async function(){ await loadPlayers(); await loadEvents(); })();
</script>

</body>
</html>
