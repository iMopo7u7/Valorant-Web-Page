<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eventos / Torneos Valorant</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
  header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
  main { padding:1rem; max-width:1200px; margin:auto; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; background:white; }
  th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
  .form-inline { display:flex; flex-wrap:wrap; align-items:center; gap:0.5rem; margin-bottom:0.5rem; }
  input, select { padding:0.3rem; }
  button { padding:0.3rem 0.6rem; cursor:pointer; margin-top:0.2rem; }
  #eventMatchesPanel { background:#fff; padding:1rem; border:1px solid #ccc; margin-top:1rem; display:none; }
  .teams { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
  .player-row { display:flex; gap:0.3rem; margin-bottom:0.3rem; align-items:center; }
  .hint { font-size:0.85rem; color:#666; }
  .section-title { margin-top:1rem; font-weight:bold; }
  .error { color:red; font-size:0.85rem; }
</style>
</head>
<body>

<header><h1>EVENTOS / TORNEOS</h1></header>

<main>
  <div class="form-inline">
    <button id="backToAdminBtn">Regresar a Admin</button>
  </div>

  <!-- Crear evento -->
  <div id="createEventForm" class="form-inline">
    <input type="text" id="eventName" placeholder="Nombre del evento" required>
    <select id="eventBadge">
      <option value="">Selecciona Badge</option>
      <option value="champion">Champion ðŸ‘‘</option>
      <option value="finalist">Finalist ðŸ¥ˆ</option>
      <option value="semifinalist">Semifinalist ðŸ¥‰</option>
      <option value="participant">Participant ðŸŽ¯</option>
    </select>
    <select id="eventTeamSize">
      <option value="">TamaÃ±o de equipo</option>
      <option value="1">1vs1</option>
      <option value="2">2vs2</option>
      <option value="3">3vs3</option>
      <option value="4">4vs4</option>
      <option value="5">5vs5</option>
    </select>
    <select id="eventNumTeams">
      <option value="">NÃºmero de equipos</option>
      <option value="2">2</option>
      <option value="4">4</option>
      <option value="8">8</option>
      <option value="16">16</option>
    </select>
    <button id="createEventBtn">Crear Evento</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>TamaÃ±o</th>
        <th># Equipos</th>
        <th># Partidas</th>
        <th>Badge</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="eventsTableBody">
      <tr><td colspan="6">Cargando...</td></tr>
    </tbody>
  </table>

  <!-- Panel de editar evento y registrar partidas -->
  <div id="eventMatchesPanel">
    <h3 id="eventMatchesTitle">Partidas del Evento</h3>
    <div id="eventMatchesList" class="hint">No hay partidas aÃºn</div>

    <h4 class="section-title">Equipos</h4>
    <div class="teams">
      <div>
        <h5>Equipo A</h5>
        <div id="eventTeamA"></div>
      </div>
      <div>
        <h5>Equipo B</h5>
        <div id="eventTeamB"></div>
      </div>
    </div>

    <h4 class="section-title">Agregar Partida</h4>
    <div id="addEventMatchForm">
      <div class="form-inline">
        <label>Mapa:</label>
        <select id="eventMatchMap">
          <option value="">Selecciona mapa</option>
          <option value="Bind">Bind</option>
          <option value="Haven">Haven</option>
          <option value="Split">Split</option>
          <option value="Ascent">Ascent</option>
          <option value="Icebox">Icebox</option>
          <option value="Breeze">Breeze</option>
          <option value="Corrode">Corrode</option>
          <option value="Abyss">Abyss</option>
          <option value="Sunset">Sunset</option>
          <option value="Lotus">Lotus</option>
          <option value="Pearl">Pearl</option>
          <option value="Fracture">Fracture</option>
        </select>

        <label>Ganador:</label>
        <select id="eventWinnerTeam">
          <option value="">Seleccionar</option>
          <option value="A">Equipo A</option>
          <option value="B">Equipo B</option>
        </select>

        <label>Marcador:</label>
        <input type="text" id="eventMatchScore" placeholder="Ej: 13-8">
      </div>

      <div class="hint">Ingresa estadÃ­sticas por jugador: Kills, Deaths, Assists, ACS, HS%, First Bloods.</div>

      <div class="form-inline">
        <button id="submitEventMatchBtn">Registrar Partida</button>
        <button id="closeEventMatches" style="margin-left:auto;">Cerrar</button>
      </div>
    </div>
  </div>
</main>

<script>
const API_URL = window.location.origin;
let allEvents = [], allPlayers = [], currentEvent = null, currentEventMatches = [], currentTeamSize = 5;

// --- Utils ---
function sanitizeInt(n){ const x=parseInt(n,10); return Number.isFinite(x)?x:0; }

// --- Load players ---
async function loadPlayers(){
  const res = await fetch('/players',{credentials:'include'});
  allPlayers = res.ok? await res.json() : [];
}

// --- Load events ---
async function loadEvents(){
  const res = await fetch('/events',{credentials:'include'});
  allEvents = res.ok? await res.json() : [];
  renderEvents();
}

// --- Badge icons ---
function getBadgeIcon(type){
  switch(type){
    case 'champion': return 'ðŸ‘‘'; 
    case 'finalist': return 'ðŸ¥ˆ'; 
    case 'semifinalist': return 'ðŸ¥‰'; 
    case 'participant': return 'ðŸŽ¯'; 
    default: return type; 
  }
}

// --- Render events table ---
function renderEvents(){
  const tbody=document.getElementById('eventsTableBody'); 
  tbody.innerHTML='';
  if(!allEvents.length){ 
    tbody.innerHTML='<tr><td colspan="6">No hay eventos creados</td></tr>'; 
    return; 
  }
  allEvents.forEach((ev,i)=>{
    const row=document.createElement('tr');
    row.innerHTML=`
      <td>${ev.name}</td>
      <td>${ev.teamSize}vs${ev.teamSize}</td>
      <td>${ev.numTeams}</td>
      <td>${ev.matches.length||0}</td>
      <td>${getBadgeIcon(ev.badge)}</td>
      <td><button class="btn-view" data-index="${i}">Ver / Editar</button></td>
    `;
    tbody.appendChild(row);
  });

  document.querySelectorAll('.btn-view').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.btn-view').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentEvent = allEvents[btn.dataset.index];
      currentTeamSize = parseInt(currentEvent.teamSize,10);
      document.getElementById('eventMatchesTitle').innerText = `Evento: ${currentEvent.name}`;
      currentEventMatches = currentEvent.matches || [];
      renderEventMatchesList(currentEvent, currentEventMatches);
      document.getElementById('eventMatchesPanel').style.display='block';
      populateEventTeams();
    });
  });
}

// --- Render matches ---
function renderEventMatchesList(ev,matches){
  const list=document.getElementById('eventMatchesList');
  list.innerHTML = matches.length? matches.map((m,idx)=>`<div>#${idx+1}: ${(m.teamA?.map(p=>p.name).join(',')||'A')} vs ${(m.teamB?.map(p=>p.name).join(',')||'B')} | ${m.map||'-'} | Ganador: ${m.winnerTeam||'-'} | Score: ${m.score||'-'}</div>`).join('') 
  : 'No hay partidas aÃºn';
}

// --- Create event ---
document.getElementById('createEventBtn').addEventListener('click', async ()=>{
  const name=document.getElementById('eventName').value.trim();
  const teamSize=parseInt(document.getElementById('eventTeamSize').value);
  const numTeams=parseInt(document.getElementById('eventNumTeams').value);
  const badge=document.getElementById('eventBadge').value;
  if(!name || !teamSize || !numTeams){ return alert('Completa nombre, tamaÃ±o de equipo y nÃºmero de equipos'); }

  // Inicializa equipos vacÃ­os
  const eventTeams={};
  for(let i=0;i<numTeams;i++){ eventTeams[String.fromCharCode(65+i)] = []; }

  const res = await fetch('/events',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({name,teamSize,numTeams,badge,teams:eventTeams,matches:[]})
  });
  if(!res.ok) return alert('Error creando evento');
  alert('Evento creado exitosamente');
  document.getElementById('eventName').value='';
  document.getElementById('eventTeamSize').value='';
  document.getElementById('eventNumTeams').value='';
  document.getElementById('eventBadge').value='';
  loadEvents();
});

// --- Populate teams ---
function populateEventTeams(){
  const teamContainers = {A: document.getElementById('eventTeamA'), B: document.getElementById('eventTeamB')};
  teamContainers.A.innerHTML=''; teamContainers.B.innerHTML='';

  if(!currentEvent || !currentEvent.teams) return;

  const teamKeys = Object.keys(currentEvent.teams).slice(0,2); // Solo mostrar A y B
  teamKeys.forEach((teamKey,idx)=>{
    const container = idx===0? teamContainers.A : teamContainers.B;
    currentEvent.teams[teamKey].forEach(player=>{
      const row=document.createElement('div'); 
      row.className='player-row';
      row.innerHTML=`
        <input type="text" value="${player.name}" disabled>
        <input type="number" class="kill" placeholder="Kills" min="0">
        <input type="number" class="death" placeholder="Deaths" min="0">
        <input type="number" class="assist" placeholder="Assists" min="0">
        <input type="number" class="acs" placeholder="ACS" min="0">
        <input type="number" class="fb" placeholder="FirstBloods" min="0">
        <input type="number" class="hs" placeholder="HS%" min="0">
      `;
      container.appendChild(row);
    });
  });
}

// --- Register match ---
document.getElementById('submitEventMatchBtn').addEventListener('click', async ()=>{
  if(!currentEvent) return alert('Selecciona evento');
  const map=document.getElementById('eventMatchMap').value;
  const winnerTeam=document.getElementById('eventWinnerTeam').value;
  const score=document.getElementById('eventMatchScore').value.trim();
  if(!map || !winnerTeam || !score) return alert('Completa mapa, ganador y marcador');

  const teams = {};
  ['A','B'].forEach(teamLabel=>{
    const container = teamLabel==='A'? document.getElementById('eventTeamA') : document.getElementById('eventTeamB');
    teams[teamLabel] = [...container.querySelectorAll('.player-row')].map(row=>({
      name: row.querySelector('input[type=text]').value,
      kills: sanitizeInt(row.querySelector('.kill').value),
      deaths: sanitizeInt(row.querySelector('.death').value),
      assists: sanitizeInt(row.querySelector('.assist').value),
      acs: sanitizeInt(row.querySelector('.acs').value),
      firstBloods: sanitizeInt(row.querySelector('.fb').value),
      hsPercent: sanitizeInt(row.querySelector('.hs').value)
    }));
  });

  const match={map, winnerTeam, score, teamA: teams.A, teamB: teams.B};
  const res=await fetch(`/events/${currentEvent._id}/matches`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify(match)
  });
  if(!res.ok) return alert('Error agregando partida');

  alert('Partida registrada');
  currentEvent.matches.push(match);
  renderEventMatchesList(currentEvent,currentEvent.matches);
  populateEventTeams();
  document.getElementById('eventMatchMap').value='';
  document.getElementById('eventWinnerTeam').value='';
  document.getElementById('eventMatchScore').value='';
});

// --- Close matches panel ---
document.getElementById('closeEventMatches').addEventListener('click', ()=>{
  document.getElementById('eventMatchesPanel').style.display='none';
  currentEvent=null;
  currentEventMatches=[];
});

// --- Back to admin ---
document.getElementById('backToAdminBtn').addEventListener('click', ()=>{window.location.href='/admin.html';});

// --- Init ---
(async function init(){ 
  await loadPlayers(); 
  await loadEvents(); 
})();
</script>

</body>
</html>
