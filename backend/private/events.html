<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eventos / Torneos Valorant</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  header { background:#1a1a1a; color:white; padding:1rem; text-align:center; }
  main { padding:1rem; }
  form.form-inline input, form.form-inline select { margin-right:0.5rem; margin-bottom:0.3rem; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; }
  table th, table td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
  button { padding:0.3rem 0.5rem; margin-left:0.2rem; cursor:pointer; }
  #eventMatchesPanel { background:#f9f9f9; padding:0.75rem; border:1px solid #ccc; margin-top:0.75rem; }
  .section-title { margin-top:1rem; }
  .teams { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
  .form-inline { display:flex; flex-wrap:wrap; align-items:center; }
  .row { margin-bottom:0.35rem; }
  .hint { font-size: 0.85rem; color:#666; }
</style>
</head>
<body>

<header><h1>EVENTOS / TORNEOS</h1></header>

<main>
  <div class="form-inline" style="margin-bottom:1rem;">
    <button id="backToAdminBtn">Regresar a Admin</button>
  </div>

  <!-- Crear evento -->
  <div id="createEventForm" class="form-inline" style="margin-bottom:1rem;">
    <input type="text" id="eventName" placeholder="Nombre del evento" required>
    <select id="eventTeamSize">
      <option value="">Tamaño de equipo</option>
      <option value="1">1vs1</option>
      <option value="2">2vs2</option>
      <option value="3">3vs3</option>
      <option value="4">4vs4</option>
      <option value="5">5vs5</option>
    </select>
    <select id="eventNumTeams">
      <option value="">Número de equipos</option>
      <option value="2">2</option>
      <option value="4">4</option>
      <option value="8">8</option>
      <option value="16">16</option>
    </select>
    <button id="createEventBtn">Crear Evento</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Tamaño</th>
        <th># Equipos</th>
        <th>Equipos Definidos</th>
        <th>Partidas</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="eventsTableBody">
      <tr><td colspan="6">Cargando...</td></tr>
    </tbody>
  </table>

  <div id="eventTeamsPanel" style="display:none;">
    <h3 id="eventTeamsTitle">Definir Equipos</h3>
    <div id="teamsContainer" class="teams"></div>
    <button id="saveTeamsBtn" style="margin-top:0.5rem;">Guardar Equipos</button>
  </div>

  <div id="eventMatchesPanel" style="display:none;">
    <h3 id="eventMatchesTitle">Partidas del Evento</h3>
    <div id="eventMatchesList" class="hint">No hay partidas aún</div>

    <h4 class="section-title">Agregar Partida</h4>
    <div id="addEventMatchForm">
      <div class="form-inline row">
        <label>Equipo A:</label>
        <select id="eventTeamSelectA"></select>
        <label>Equipo B:</label>
        <select id="eventTeamSelectB"></select>
        <label>Ganador:</label>
        <select id="eventWinnerTeam">
          <option value="">Seleccionar</option>
          <option value="A">Equipo A</option>
          <option value="B">Equipo B</option>
        </select>
        <label>Mapa:</label>
        <select id="eventMatchMap">
          <option value="">Selecciona mapa</option>
          <option value="Bind">Bind</option>
          <option value="Haven">Haven</option>
          <option value="Split">Split</option>
          <option value="Ascent">Ascent</option>
          <option value="Icebox">Icebox</option>
          <option value="Breeze">Breeze</option>
        </select>
        <input type="text" id="eventMatchScore" placeholder="Marcador (Ej: 13-8)">
      </div>

      <div class="form-inline" style="margin-top:8px;">
        <button id="submitEventMatchBtn">Registrar Partida</button>
        <button id="closeEventMatches" style="margin-left:auto;">Cerrar</button>
      </div>
    </div>
  </div>
</main>

<script>
const API_URL = window.location.origin;
let allEvents = [], allPlayers = [], currentEvent = null, eventTeams = {};

async function loadPlayers(){
  const res = await fetch('/players',{credentials:'include'});
  allPlayers = res.ok ? await res.json() : [];
}

async function loadEvents(){
  const res = await fetch('/events',{credentials:'include'});
  allEvents = res.ok ? await res.json() : [];
  renderEvents();
}

function renderEvents(){
  const tbody=document.getElementById('eventsTableBody');
  tbody.innerHTML='';
  if(!allEvents.length){ tbody.innerHTML='<tr><td colspan="6">No hay eventos</td></tr>'; return; }
  allEvents.forEach((ev,i)=>{
    const row=document.createElement('tr');
    row.innerHTML=`
      <td>${ev.name}</td>
      <td>${ev.teamSize}vs${ev.teamSize}</td>
      <td>${ev.numTeams}</td>
      <td>${ev.teams ? Object.keys(ev.teams).length : 0}</td>
      <td>${ev.matches ? ev.matches.length : 0}</td>
      <td><button class="btn-edit" data-index="${i}">Editar</button></td>
    `;
    tbody.appendChild(row);
  });

  document.querySelectorAll('.btn-edit').forEach(btn=>{
    btn.addEventListener('click',()=>{
      currentEvent = allEvents[btn.dataset.index];
      showTeamsPanel();
      showMatchesPanel();
    });
  });
}

function showTeamsPanel(){
  document.getElementById('eventTeamsPanel').style.display='block';
  document.getElementById('eventTeamsTitle').innerText = `Definir Equipos: ${currentEvent.name}`;
  const container = document.getElementById('teamsContainer');
  container.innerHTML='';
  eventTeams = currentEvent.teams || {};

  for(let i=0;i<currentEvent.numTeams;i++){
    const teamLabel = String.fromCharCode(65+i);
    eventTeams[teamLabel] = eventTeams[teamLabel] || [];
    const div = document.createElement('div');
    div.innerHTML = `<h5>Equipo ${teamLabel}</h5>`;
    for(let j=0;j<currentEvent.teamSize;j++){
      const select=document.createElement('select');
      select.className='player-select';
      select.innerHTML=`<option value="">-- Selecciona jugador --</option>` + allPlayers.map(p=>`<option value="${p.name}||${p.tag}" ${eventTeams[teamLabel][j]&&eventTeams[teamLabel][j].name===p.name?'selected':''}>${p.name} (${p.tag})</option>`).join('');
      div.appendChild(select);
    }
    container.appendChild(div);
  }
}

document.getElementById('saveTeamsBtn').addEventListener('click', async()=>{
  const selects = document.querySelectorAll('#teamsContainer .player-select');
  let valid = true;
  const used = new Set();
  selects.forEach(sel=>{
    if(!sel.value) valid=false;
    if(used.has(sel.value)) valid=false;
    used.add(sel.value);
  });
  if(!valid) return alert('Selecciona todos los jugadores y no repitas');
  // Guardar equipos
  Object.keys(eventTeams).forEach((teamLabel,i)=>{
    eventTeams[teamLabel]=[];
    document.querySelectorAll('#teamsContainer div')[i].querySelectorAll('select').forEach(sel=>{
      const [name,tag]=sel.value.split('||');
      eventTeams[teamLabel].push({name,tag});
    });
  });
  // Enviar al backend
  const res = await fetch(`/events/${currentEvent._id}`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({teams:eventTeams})
  });
  if(!res.ok) return alert('Error guardando equipos');
  alert('Equipos guardados');
  loadEvents();
});

function showMatchesPanel(){
  document.getElementById('eventMatchesPanel').style.display='block';
  document.getElementById('eventMatchesTitle').innerText = `Partidas del Evento: ${currentEvent.name}`;
  renderMatchesList();
  populateMatchSelectors();
}

function renderMatchesList(){
  const list=document.getElementById('eventMatchesList');
  const matches = currentEvent.matches || [];
  if(!matches.length){ list.innerHTML='No hay partidas'; return; }
  list.innerHTML = matches.map((m,idx)=>`<div>#${idx+1}: ${m.teamA.map(p=>p.name).join(',')} vs ${m.teamB.map(p=>p.name).join(',')} | Ganador: ${m.winnerTeam} | ${m.map} | ${m.score}</div>`).join('');
}

function populateMatchSelectors(){
  const selA=document.getElementById('eventTeamSelectA');
  const selB=document.getElementById('eventTeamSelectB');
  selA.innerHTML=''; selB.innerHTML='';
  Object.keys(eventTeams).forEach(t=>{
    selA.innerHTML+=`<option value="${t}">${t}</option>`;
    selB.innerHTML+=`<option value="${t}">${t}</option>`;
  });
}

document.getElementById('submitEventMatchBtn').addEventListener('click', async()=>{
  const tA=document.getElementById('eventTeamSelectA').value;
  const tB=document.getElementById('eventTeamSelectB').value;
  const winner=document.getElementById('eventWinnerTeam').value;
  const map=document.getElementById('eventMatchMap').value;
  const score=document.getElementById('eventMatchScore').value.trim();
  if(!tA||!tB||!winner||!map||!score) return alert('Completa todos los campos');
  if(tA===tB) return alert('Elige equipos diferentes');

  const match = {
    teamA: eventTeams[tA],
    teamB: eventTeams[tB],
    winnerTeam: winner,
    map,
    score
  };
  // Guardar partida en el evento
  const res = await fetch(`/events/${currentEvent._id}/matches`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify(match)
  });
  if(!res.ok) return alert('Error guardando partida');
  currentEvent = await res.json(); // Devuelve el evento actualizado con matches
  renderMatchesList();
});

document.getElementById('closeEventMatches').addEventListener('click',()=>{
  document.getElementById('eventMatchesPanel').style.display='none';
  currentEvent=null;
});

document.getElementById('backToAdminBtn').addEventListener('click',()=>{window.location.href='/admin.html';});

document.getElementById('createEventBtn').addEventListener('click', async()=>{
  const name=document.getElementById('eventName').value.trim();
  const teamSize=parseInt(document.getElementById('eventTeamSize').value);
  const numTeams=parseInt(document.getElementById('eventNumTeams').value);
  if(!name||!teamSize||!numTeams) return alert('Completa datos');
  const res = await fetch('/events',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({name,teamSize,numTeams,teams:{},matches:[]})
  });
  if(!res.ok) return alert('Error creando evento');
  alert('Evento creado');
  document.getElementById('eventName').value='';
  document.getElementById('eventTeamSize').value='';
  document.getElementById('eventNumTeams').value='';
  loadEvents();
});

(async function init(){ await loadPlayers(); await loadEvents(); })();
</script>

</body>
</html>
