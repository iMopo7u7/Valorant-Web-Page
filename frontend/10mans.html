<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant 10-Mans System</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap');

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors */
            --bg-primary: hsl(220, 13%, 9%);
            --bg-secondary: hsl(220, 13%, 12%);
            --bg-card: hsl(220, 13%, 15%);
            --valorant-red: hsl(351, 100%, 61%);
            --valorant-blue: hsl(208, 100%, 70%);
            --text-primary: hsl(0, 0%, 95%);
            --text-secondary: hsl(0, 0%, 70%);
            --text-muted: hsl(0, 0%, 50%);
            --border-color: hsl(0, 0%, 20%);
            --accent: hsl(351, 100%, 61%);

            /* Fonts */
            --font-orbitron: 'Orbitron', monospace;
            --font-rajdhani: 'Rajdhani', sans-serif;

            /* Animations */
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.2s ease-out;

            /* Gradients */
            --gradient-valorant: linear-gradient(135deg, hsl(351 100% 61% / 0.2), hsl(208 100% 70% / 0.1));
            --gradient-neon: linear-gradient(90deg, hsl(351 100% 61%) 0%, hsl(351 85% 65%) 100%);
            --gradient-card: linear-gradient(145deg, hsl(220 13% 15%) 0%, hsl(220 13% 12%) 100%);

            /* Shadows */
            --shadow-neon: 0 0 20px hsl(351 100% 61% / 0.3);
            --shadow-card: 0 4px 24px hsl(220 30% 6% / 0.5);
            --shadow-intense: 0 0 40px hsl(351 100% 61% / 0.5);
        }

        body {
            font-family: var(--font-rajdhani);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
        }

        .logo {
            font-family: var(--font-orbitron);
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text-primary);
        }

        .logo .accent {
            color: var(--valorant-red);
            text-shadow: 0 0 10px var(--valorant-red);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-family: var(--font-rajdhani);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
        }

        .nav-tab:hover {
            color: var(--valorant-red);
            border-color: var(--valorant-red);
            box-shadow: 0 0 20px rgba(255, 70, 85, 0.3);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, rgba(255, 70, 85, 0.1), rgba(255, 70, 85, 0.05));
            border-color: var(--valorant-red);
            color: var(--valorant-red);
            box-shadow: 0 0 20px rgba(255, 70, 85, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Styles */
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-card);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .card:hover {
            border-color: hsl(var(--valorant-red) / 0.3);
            box-shadow:
                var(--shadow-card),
                0 0 20px hsl(var(--valorant-red) / 0.1);
            transform: translateY(-2px);
        }

        .card-content {
            padding: 1.5rem;
        }

        .card-header {
            padding: 1.5rem 1.5rem 0;
        }

        .card-title {
            font-family: var(--font-orbitron);
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        /* Button Styles */
        .btn {
            background: var(--gradient-neon);
            color: var(--text-primary);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-neon);
            font-family: var(--font-rajdhani);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            box-shadow: var(--shadow-intense);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: var(--bg-card);
            color: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn:disabled:hover {
            background: var(--bg-card);
            color: var(--text-muted);
            transform: none;
            box-shadow: none;
        }

        .btn-large {
            width: 100%;
            max-width: 28rem;
            height: 4rem;
            font-size: 1.25rem;
            font-family: var(--font-orbitron);
            font-weight: 700;
            margin: 0 auto;
            display: flex;
        }

        .btn-discord {
            background: #5865F2;
        }

        .btn-discord:hover {
            background: #4752C4;
            box-shadow: 0 0 20px rgba(88, 101, 242, 0.5);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            box-shadow: none;
        }

        .btn-outline:hover {
            background: var(--bg-secondary);
            border-color: var(--valorant-red);
            color: var(--valorant-red);
            box-shadow: 0 0 10px rgba(255, 70, 85, 0.2);
        }

        /* Input Styles */
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-family: var(--font-rajdhani);
            font-size: 1rem;
            transition: var(--transition-smooth);
        }

        .input:focus {
            outline: none;
            border-color: var(--valorant-red);
            box-shadow: 0 0 10px rgba(255, 70, 85, 0.2);
        }

        .input::placeholder {
            color: var(--text-muted);
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-warning {
            background: rgba(234, 179, 8, 0.2);
            color: rgb(234, 179, 8);
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: rgb(59, 130, 246);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Avatar Styles */
        .avatar {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border: 2px solid var(--valorant-red);
            object-fit: cover;
        }

        .avatar-small {
            width: 2rem;
            height: 2rem;
        }

        /* Layout Utilities */
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .grid {
            display: grid;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .space-y-2>*+* {
            margin-top: 0.5rem;
        }

        .space-y-3>*+* {
            margin-top: 0.75rem;
        }

        .space-y-4>*+* {
            margin-top: 1rem;
        }

        .space-y-6>*+* {
            margin-top: 1.5rem;
        }

        .text-center {
            text-align: center;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-medium {
            font-weight: 500;
        }

        .text-primary {
            color: var(--valorant-red);
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-blue {
            color: rgb(59, 130, 246);
        }

        .text-red {
            color: rgb(239, 68, 68);
        }

        .text-yellow {
            color: rgb(234, 179, 8);
        }

        .bg-primary-10 {
            background: rgba(255, 70, 85, 0.1);
            border: 1px solid rgba(255, 70, 85, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
        }

        .bg-blue-10 {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        .bg-red-10 {
            background: rgba(239, 68, 68, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        .bg-secondary-20 {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .bg-accent-10 {
            background: rgba(255, 70, 85, 0.1);
            border: 1px solid rgba(255, 70, 85, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .step-number {
            background: var(--gradient-neon);
            color: var(--text-primary);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-glow {
            from {
                box-shadow: 0 0 20px rgba(255, 70, 85, 0.3);
            }

            to {
                box-shadow: 0 0 30px rgba(255, 70, 85, 0.5);
            }
        }

        .neon-text {
            color: var(--valorant-red);
            text-shadow:
                0 0 10px rgba(255, 70, 85, 0.5),
                0 0 20px rgba(255, 70, 85, 0.3),
                0 0 30px rgba(255, 70, 85, 0.1);
        }

        .hidden {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header .container {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
            }

            .nav-tab {
                flex: 1;
                text-align: center;
            }

            .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .btn-large {
                height: 3rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 1rem;
            }

            .card-content,
            .card-header {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                VALORANT<span class="accent"> LEADERBOARD - 10 MANS</span>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="10mans">10 Mans</button>
                <a href="/index.html" class="nav-tab" data-tab="leaderboard">Leaderboard</a>
                <a href="/matches.html" class="nav-tab" data-tab="matches">Matches</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">

            <!-- 10 Mans Tab -->
            <div id="10mans-content" class="tab-content active">

                <!-- User Status Section -->
                <div class="card">
                    <div class="card-content">
                        <div class="flex items-center justify-between">
                            <div id="user-info">
                                <div id="logged-out-state">
                                    <h2 class="text-xl font-bold font-orbitron"
                                        style="font-family: var(--font-orbitron); margin-bottom: 0.5rem;">
                                        Bienvenido a los 10-Mans de Valorant
                                    </h2>
                                    <p class="text-muted">
                                        Inicia sesión con Discord para participar en las partidas
                                    </p>
                                </div>

                                <div id="logged-in-state" class="hidden">
                                    <div class="flex items-center gap-4">
                                        <img id="user-avatar" class="avatar" src="" alt="User Avatar">
                                        <div>
                                            <p class="text-lg font-semibold font-orbitron" id="user-name">
                                                Usuario#0000
                                            </p>
                                            <p class="text-sm text-muted">
                                                Riot ID: <span class="text-primary" id="user-riot-id">No
                                                    registrado</span>
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Formulario para actualizar Riot ID -->
                                    <form id="riot-id-form" class="mt-3 hidden">
                                        <div class="flex gap-2">
                                            <input id="riot-id-input" class="input" type="text"
                                                placeholder="Ingresa tu Riot ID (ej: Player#1234)">
                                            <button type="submit" class="btn btn-primary">Actualizar Riot ID</button>
                                        </div>
                                    </form>

                                </div>
                            </div>

                            <button id="discord-login-btn" class="btn btn-discord">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.210 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.210 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z" />
                                </svg>
                                Login con Discord
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Play Button Section -->
                <div class="text-center space-y-4">
                    <button id="play-btn" class="btn btn-large pulse-glow">
                        ⚔️ UNIRSE A LA COLA
                    </button>

                    <div id="queue-status" class="text-lg text-muted">
                        <!-- Dynamic content will be inserted here -->
                    </div>

                    <div id="riot-id-warning" class="bg-primary-10 hidden">
                        ⚠️ Debes registrar tu Riot ID para unirte a las partidas
                    </div>
                </div>

                <!-- Leader Section -->
                <div id="leader-section" class="card hidden" style="border-color: rgba(255, 70, 85, 0.3);">
                    <div class="card-header">
                        <div class="card-title text-primary flex items-center gap-2"
                            style="color: var(--valorant-red);">
                            👑 Panel del Líder
                        </div>
                    </div>
                    <div class="card-content space-y-6">
                        <div class="space-y-4">
                            <!-- Step 1 -->
                            <div class="flex items-start gap-3 bg-primary-10">
                                <div class="step-number">1</div>
                                <div>
                                    <h3 class="font-semibold" style="margin-bottom: 0.25rem;">Crear sala en Valorant
                                    </h3>
                                    <p class="text-sm text-muted">
                                        Modo personalizado → Configuración estándar de competitivo → Mapa asignado:
                                        <span class="text-primary font-medium">Ascent</span>
                                    </p>
                                </div>
                            </div>

                            <!-- Step 2 -->
                            <div class="flex items-start gap-3 bg-secondary-20">
                                <div class="step-number"
                                    style="background: var(--bg-secondary); color: var(--text-primary);">2</div>
                                <div style="flex: 1;">
                                    <div class="space-y-3">
                                        <div>
                                            <h3 class="font-semibold" style="margin-bottom: 0.25rem;">Ingresar código de
                                                sala</h3>
                                            <p class="text-sm text-muted" style="margin-bottom: 0.5rem;">
                                                Comparte el código con los 10 jugadores
                                            </p>
                                        </div>
                                        <div class="flex gap-2">
                                            <input id="room-code-input" class="input"
                                                placeholder="Código de la sala (ej: VALORANT123)" style="flex: 1;">
                                            <button id="submit-room-code" class="btn btn-outline">Enviar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3 -->
                            <div class="flex items-start gap-3 bg-accent-10">
                                <div class="step-number">3</div>
                                <div style="flex: 1;">
                                    <div class="space-y-3">
                                        <div>
                                            <h3 class="font-semibold" style="margin-bottom: 0.25rem;">Subir resultado
                                                del tracker</h3>
                                            <p class="text-sm text-muted" style="margin-bottom: 0.5rem;">
                                                Una vez finalizada la partida, ingresa la URL del Tracker.gg
                                            </p>
                                        </div>
                                        <div class="flex gap-2">
                                            <input id="tracker-url-input" class="input"
                                                placeholder="https://tracker.gg/valorant/match/..." style="flex: 1;">
                                            <button id="submit-tracker" class="btn btn-outline">Subir</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Matches Section -->
                <div>
                    <h2 class="text-2xl font-bold neon-text"
                        style="font-family: var(--font-orbitron); margin-bottom: 1.5rem;">
                        Partidas Activas
                    </h2>

                    <div id="matches-container">
                        <!-- Dynamic matches will be inserted here -->
                    </div>
                </div>

            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard-content" class="tab-content">
                <div class="card">
                    <div class="card-content">
                        <div class="text-center" style="padding: 2rem;">
                            <h2 class="text-2xl font-bold neon-text" style="font-family: var(--font-orbitron);">
                                Leaderboard</h2>
                            <p class="text-muted" style="font-family: var(--font-rajdhani);">Coming soon...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matches Tab -->
            <div id="matches-content" class="tab-content">
                <div class="card">
                    <div class="card-content">
                        <div class="text-center" style="padding: 2rem;">
                            <h2 class="text-2xl font-bold neon-text" style="font-family: var(--font-orbitron);">Match
                                History</h2>
                            <p class="text-muted" style="font-family: var(--font-rajdhani);">Coming soon...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

<script>
const API_BASE = "https://valorant-10-mans.onrender.com";
let currentUser = null;
let isQueueOpen = false;
let activeMatches = [];
let inQueue = false;

// ------------------------
// --- Inicialización
// ------------------------
document.addEventListener("DOMContentLoaded", async () => {
    setupTabs();
    setupEventListeners();
    await fetchCurrentUser();
    await updateQueueAndMatches();
    setInterval(updateQueueAndMatches, 10000);
});

// ------------------------
// --- Tabs
// ------------------------
function setupTabs() {
    const tabs = document.querySelectorAll('.nav-tab');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '-content').classList.add('active');
        });
    });
}

// ------------------------
// --- Event Listeners
// ------------------------
function setupEventListeners() {
    document.getElementById('discord-login-btn')?.addEventListener('click', () =>
        window.location.href = `${API_BASE}/api/auth/discord`
    );

    document.getElementById('play-btn')?.addEventListener('click', async () => {
        if (!currentUser) return alert("Debes iniciar sesión con Discord primero");
        if (!currentUser.riotId) return alert("Debes registrar tu Riot ID");
        if (!isQueueOpen) return alert("La cola está cerrada");

        if (inQueue) {
            // Si está en partida: leaveQueue, si solo en cola global: leaveGlobalQueue
            const match = activeMatches.find(m => m.players?.some(p => p.discordId === currentUser.discordId));
            if (match) await leaveQueue();
            else await leaveGlobalQueue();
        } else {
            await joinQueue();
        }
    });

    document.getElementById('riot-id-form')?.addEventListener('submit', async e => {
        e.preventDefault();
        const riotId = document.getElementById('riot-id-input')?.value.trim();
        if (riotId) {
            await updateRiotId(riotId);
            document.getElementById('riot-id-input').value = '';
        }
    });

    document.getElementById('submit-room-code')?.addEventListener('click', async () => {
        const match = activeMatches.find(m => m.leaderId === currentUser?.discordId);
        if (!match) return alert("Solo el líder puede enviar el código de sala");
        const code = document.getElementById('room-code-input').value.trim();
        if (!code) return alert("Ingresa un código válido");
        await updateRoomCode(match._id, code);
    });

    document.getElementById('submit-tracker')?.addEventListener('click', async () => {
        const match = activeMatches.find(m => m.leaderId === currentUser?.discordId);
        if (!match) return alert("Solo el líder puede subir el tracker");
        const url = document.getElementById('tracker-url-input').value.trim();
        if (!url) return alert("Ingresa una URL válida");
        await updateTrackerUrl(match._id, url);
    });
}

// ------------------------
// --- Usuarios y Riot ID
// ------------------------
async function fetchCurrentUser() {
    try {
        const res = await fetch(`${API_BASE}/api/users/me`, { credentials: "include" });
        if (!res.ok) { currentUser = null; updateUserDisplay(); return; }
        currentUser = await res.json();
    } catch (err) {
        console.error(err);
        currentUser = null;
    }
    updateUserDisplay();
}

async function updateRiotId(riotId) {
    try {
        const res = await fetch(`${API_BASE}/api/users/update-riot`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ riotId })
        });
        if (!res.ok) throw new Error("Error actualizando Riot ID");
        currentUser.riotId = riotId;
        updateUserDisplay();
        alert("Riot ID actualizado correctamente");
    } catch (err) {
        console.error(err);
        alert(err.message || "Error al actualizar Riot ID");
    }
}

function updateUserDisplay() {
    const loggedOut = document.getElementById('logged-out-state');
    const loggedIn = document.getElementById('logged-in-state');
    const riotWarning = document.getElementById('riot-id-warning');
    const leaderSection = document.getElementById('leader-section');

    if (currentUser) {
        loggedOut?.classList.add('hidden');
        loggedIn?.classList.remove('hidden');
        document.getElementById('user-avatar').src = currentUser.avatar
            ? `https://cdn.discordapp.com/avatars/${currentUser.discordId}/${currentUser.avatar}.png`
            : '/default-avatar.png';
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-riot-id').textContent = currentUser.riotId || "No registrado";
        document.getElementById('riot-id-form')?.classList.toggle('hidden', !!currentUser.riotId);

        leaderSection?.classList.toggle('hidden', !activeMatches.some(m => m.leaderId === currentUser.discordId));
    } else {
        loggedOut?.classList.remove('hidden');
        loggedIn?.classList.add('hidden');
        riotWarning?.classList.add('hidden');
        leaderSection?.classList.add('hidden');
    }

    updateQueueButton();
}

// ------------------------
// --- Cola y Partidas
// ------------------------
async function updateQueueAndMatches() {
    await fetchActiveMatches();
    updateQueueStatus();
}

async function fetchActiveMatches() {
    try {
        const res = await fetch(`${API_BASE}/api/queue/active`, { credentials: "include" });
        if (!res.ok) throw new Error("Error cargando partidas");
        activeMatches = await res.json();

        // Verificar si el usuario está en partida
        const inMatch = activeMatches.some(m => m.players?.some(p => p.discordId === currentUser?.discordId));

        // Verificar si el usuario está en la cola global
        const queueRes = await fetch(`${API_BASE}/api/queue/active`, { credentials: "include" });
        const queueData = await queueRes.json();
        const globalQueue = queueData._id === "globalQueue" && queueData.players?.includes(currentUser?.discordId);

        inQueue = inMatch || globalQueue;

        renderMatches(activeMatches);
        updateUserDisplay();
    } catch (err) {
        console.error(err);
    }
}

async function joinQueue() {
    try {
        const res = await fetch(`${API_BASE}/api/queue/join`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include"
        });
        if (!res.ok) throw new Error("Error al unirse a la cola");

        const data = await res.json();
        const updatedMatch = data.match || null;

        if (updatedMatch) {
            const idx = activeMatches.findIndex(m => m._id === updatedMatch._id);
            if (idx >= 0) activeMatches[idx] = updatedMatch;
            else activeMatches.push(updatedMatch);

            inQueue = true;
            renderMatches(activeMatches);

            if (updatedMatch.status === 'in_progress') {
                alert(`¡Partida iniciada automáticamente! Mapa: ${updatedMatch.map}`);
            }
        } else {
            inQueue = true;
            alert("Jugador agregado a la cola global, esperando partida...");
        }
        updateQueueButton();
    } catch (err) {
        console.error(err);
        alert("Error al unirse a la cola");
    }
}

async function leaveQueue() {
    try {
        const res = await fetch(`${API_BASE}/api/queue/leave`, { method: "POST", credentials: "include" });
        if (!res.ok) throw new Error("Error al salir de la partida");

        inQueue = false;
        updateQueueButton();
        await fetchActiveMatches();
    } catch (err) {
        console.error(err);
        alert("Error al salir de la partida");
    }
}

async function leaveGlobalQueue() {
    try {
        const res = await fetch(`${API_BASE}/api/queue/leave-global`, { method: "POST", credentials: "include" });
        if (!res.ok) throw new Error("Error al salir de la cola global");

        inQueue = false;
        updateQueueButton();
        alert("Has salido de la cola global");
    } catch (err) {
        console.error(err);
        alert("Error al salir de la cola global");
    }
}

// ------------------------
// --- Botón Cola
// ------------------------
function updateQueueButton() {
    const playBtn = document.getElementById('play-btn');
    const riotWarning = document.getElementById('riot-id-warning');
    if (!playBtn) return;

    const canPlay = isQueueOpen && currentUser?.riotId;

    if (inQueue) {
        playBtn.textContent = "⌛ Esperando partida... (Clic para salir)";
        playBtn.disabled = false;
    } else if (!isQueueOpen) {
        playBtn.textContent = "⏰ COLA CERRADA";
        playBtn.disabled = true;
    } else if (!currentUser?.riotId) {
        playBtn.textContent = "⚔️ UNIRSE A LA COLA";
        playBtn.disabled = true;
        riotWarning?.classList.remove('hidden');
    } else {
        playBtn.textContent = "⚔️ UNIRSE A LA COLA";
        playBtn.disabled = false;
    }
}

// ------------------------
// --- Render Partidas
// ------------------------
function renderMatches(matches) {
    const container = document.getElementById('matches-container');
    if (!container) return;

    if (!matches.length) {
        container.innerHTML = `<div class="card"><div class="card-content text-center"><p class="text-muted">No hay partidas activas</p></div></div>`;
        return;
    }

    container.innerHTML = matches.map(m => {
        const playersCount = m.players?.length || 0;
        const isLeader = currentUser?.discordId === m.leaderId;
        return `
<div class="card match-card">
  <div class="card-content">
    <div class="flex justify-between items-center mb-3">
      <span class="badge badge-${m.status === 'waiting' ? 'warning' : 'success'}">${m.status.toUpperCase()}</span>
      <span class="text-sm text-muted">${playersCount}/10 jugadores</span>
    </div>
    <div class="flex justify-between items-center mb-4">
      <div>
        <h4 class="font-bold">${m.map || 'Mapa aleatorio'}</h4>
        <p class="text-sm text-muted">Líder: ${isLeader ? 'Tú' : 'Otro jugador'}</p>
      </div>
    </div>
  </div>
</div>`;
    }).join('');

    renderLeaderInputs(matches.find(m => m.leaderId === currentUser?.discordId));
}

// ------------------------
// --- Inputs Líder
// ------------------------
function renderLeaderInputs(match) {
    const isLeader = !!match;
    const roomWrapper = document.getElementById('room-code-input')?.parentElement;
    const trackerWrapper = document.getElementById('tracker-url-input')?.parentElement;

    if (!roomWrapper || !trackerWrapper) return;

    roomWrapper.style.display = isLeader ? 'flex' : 'none';
    trackerWrapper.style.display = isLeader ? 'flex' : 'none';
    document.getElementById('submit-room-code').style.display = isLeader ? 'block' : 'none';
    document.getElementById('submit-tracker').style.display = isLeader ? 'block' : 'none';

    if (!isLeader) return;

    const roomInput = document.getElementById('room-code-input');
    roomInput.value = match.roomCode || '';
    roomInput.disabled = !!match.roomCode;

    const trackerInput = document.getElementById('tracker-url-input');
    trackerInput.value = match.trackerUrl || '';
    trackerInput.disabled = !!match.trackerUrl;
}

// ------------------------
// --- Room & Tracker
// ------------------------
async function updateRoomCode(matchId, roomCode) {
    if (!/^[A-Z0-9]{6}$/.test(roomCode)) return alert("Código inválido. Debe tener 6 caracteres alfanuméricos mayúsculas.");

    try {
        const res = await fetch(`${API_BASE}/api/queue/submit-room-code`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ matchId, roomCode })
        });
        if (!res.ok) throw new Error("Error al actualizar código de sala");
        alert("Código de sala actualizado correctamente");
        await fetchActiveMatches();
    } catch (err) {
        console.error(err);
        alert("Error al actualizar código de sala");
    }
}

async function updateTrackerUrl(matchId, trackerUrl) {
    const regex = /^https:\/\/tracker\.gg\/valorant\/match\/[0-9a-fA-F\-]{36}$/;
    if (!regex.test(trackerUrl)) return alert("URL de tracker inválida");

    try {
        const res = await fetch(`${API_BASE}/api/queue/submit-tracker`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ matchId, trackerUrl })
        });
        if (!res.ok) throw new Error("Error al subir tracker");
        alert("Tracker subido correctamente. Partida finalizada.");
        await fetchActiveMatches();
    } catch (err) {
        console.error(err);
        alert("Error al subir tracker URL");
    }
}
</script>

</body>
</html>
