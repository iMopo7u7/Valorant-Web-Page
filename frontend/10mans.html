<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant 10-Mans - Sistema de Cola</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Valorant Dark Theme */
            --background: 215 25% 8%;
            --foreground: 0 0% 95%;
            --card: 215 25% 10%;
            --card-foreground: 0 0% 90%;
            --primary: 350 85% 55%;
            --primary-foreground: 0 0% 98%;
            --primary-glow: 350 85% 65%;
            --secondary: 215 25% 15%;
            --secondary-foreground: 0 0% 85%;
            --muted: 215 25% 12%;
            --muted-foreground: 215 15% 60%;
            --accent: 350 85% 55%;
            --accent-foreground: 0 0% 95%;
            --border: 215 25% 18%;
            --input: 215 25% 15%;
            --valorant-red: 350 85% 55%;
            --valorant-red-glow: 350 85% 65%;
            --valorant-blue: 195 85% 55%;
            --valorant-dark: 215 25% 8%;
            --gradient-neon: linear-gradient(90deg, hsl(350 85% 55%) 0%, hsl(350 85% 65%) 100%);
            --gradient-card: linear-gradient(145deg, hsl(215 25% 10%) 0%, hsl(215 25% 8%) 100%);
            --shadow-neon: 0 0 20px hsl(350 85% 55% / 0.3);
            --shadow-card: 0 4px 24px hsl(215 30% 6% / 0.5);
            --shadow-intense: 0 0 40px hsl(350 85% 55% / 0.5);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: hsl(var(--secondary));
            border-bottom: 1px solid hsl(var(--border));
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 900;
            color: hsl(var(--foreground));
        }

        .logo .accent {
            color: hsl(var(--valorant-red));
            text-shadow: 0 0 10px hsl(var(--valorant-red));
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 1px solid hsl(var(--border));
            color: hsl(var(--muted-foreground));
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            text-decoration: none;
        }

        .nav-tab:hover, .nav-tab.active {
            color: hsl(var(--valorant-red));
            border-color: hsl(var(--valorant-red));
            box-shadow: 0 0 20px rgba(255, 70, 85, 0.3);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, rgba(255, 70, 85, 0.1), rgba(255, 70, 85, 0.05));
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        /* User Card Styles */
        .user-card {
            max-width: 400px;
            margin: 2rem auto;
            background: var(--gradient-card);
            border: 1px solid hsl(var(--border));
            border-radius: 1rem;
            box-shadow: var(--shadow-card);
            overflow: hidden;
            position: relative;
            transition: var(--transition-smooth);
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-neon);
        }

        .user-card-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, hsl(var(--valorant-red) / 0.2), hsl(var(--valorant-blue) / 0.1));
            background-size: cover;
            background-position: center;
            opacity: 0.3;
        }

        .user-card-content {
            position: relative;
            z-index: 2;
            padding: 2rem;
            text-align: center;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid hsl(var(--valorant-red));
            margin: 0 auto 1rem;
            display: block;
            box-shadow: var(--shadow-neon);
        }

        .user-name {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: hsl(var(--foreground));
            margin-bottom: 0.5rem;
        }

        .user-status {
            color: hsl(var(--muted-foreground));
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .play-button {
            width: 100%;
            padding: 1rem 2rem;
            background: var(--gradient-neon);
            color: hsl(var(--primary-foreground));
            border: none;
            border-radius: 0.5rem;
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-neon);
            margin-bottom: 1rem;
        }

        .play-button:hover:not(:disabled) {
            box-shadow: var(--shadow-intense);
            transform: translateY(-2px);
        }

        .play-button:disabled {
            background: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
            cursor: not-allowed;
            box-shadow: none;
        }

        .play-button::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .play-button:hover:not(:disabled)::before {
            transform: translateX(100%);
        }

        .queue-timer {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: hsl(var(--valorant-red));
            text-shadow: 0 0 10px hsl(var(--valorant-red) / 0.5);
            margin-bottom: 1rem;
        }

        .change-bg-btn {
            background: transparent;
            border: 1px solid hsl(var(--border));
            color: hsl(var(--muted-foreground));
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 0.9rem;
        }

        .change-bg-btn:hover {
            border-color: hsl(var(--valorant-red));
            color: hsl(var(--valorant-red));
        }

        /* Background Modal */
        .bg-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .bg-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bg-modal-content {
            background: var(--gradient-card);
            border: 1px solid hsl(var(--border));
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bg-modal h3 {
            font-family: 'Orbitron', monospace;
            color: hsl(var(--valorant-red));
            margin-bottom: 1rem;
            text-align: center;
        }

        .bg-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bg-option {
            width: 100px;
            height: 60px;
            border-radius: 0.5rem;
            border: 2px solid hsl(var(--border));
            cursor: pointer;
            transition: var(--transition-smooth);
            background-size: cover;
            background-position: center;
        }

        .bg-option:hover, .bg-option.selected {
            border-color: hsl(var(--valorant-red));
            box-shadow: var(--shadow-neon);
        }

        .custom-url-input {
            width: 100%;
            padding: 0.75rem;
            background: hsl(var(--input));
            border: 1px solid hsl(var(--border));
            border-radius: 0.5rem;
            color: hsl(var(--foreground));
            margin-bottom: 1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            border: 1px solid hsl(var(--border));
            border-radius: 0.25rem;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .modal-btn.primary {
            background: var(--gradient-neon);
            color: hsl(var(--primary-foreground));
            border-color: hsl(var(--valorant-red));
        }

        .modal-btn.secondary {
            background: transparent;
            color: hsl(var(--muted-foreground));
        }

        /* Lobby Styles */
        .lobby-container {
            display: none;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .lobby-container.active {
            display: block;
        }

        .lobby-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .lobby-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            color: hsl(var(--valorant-red));
            text-shadow: 0 0 20px hsl(var(--valorant-red) / 0.5);
            margin-bottom: 0.5rem;
        }

        .lobby-info {
            color: hsl(var(--muted-foreground));
            font-size: 1.1rem;
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .team {
            background: var(--gradient-card);
            border: 1px solid hsl(var(--border));
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
        }

        .team.team-a {
            border-left: 4px solid hsl(var(--valorant-blue));
        }

        .team.team-b {
            border-left: 4px solid hsl(var(--valorant-red));
        }

        .team-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
        }

        .team.team-a .team-title {
            color: hsl(var(--valorant-blue));
        }

        .team.team-b .team-title {
            color: hsl(var(--valorant-red));
        }

        .player-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: hsl(var(--muted) / 0.3);
            border-radius: 0.5rem;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.1;
            z-index: 0;
        }

        .player-card-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .player-card:hover {
            background: hsl(var(--muted) / 0.5);
            transform: translateX(5px);
        }

        .player-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid hsl(var(--valorant-red));
            box-shadow: 0 0 10px hsl(var(--valorant-red) / 0.3);
        }

        .player-info {
            flex: 1;
        }

        .player-name-small {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 0.25rem;
        }

        .player-riot-id {
            font-size: 0.85rem;
            color: hsl(var(--muted-foreground));
        }

        .leader-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Leader Panel */
        .leader-panel {
            display: none;
            background: var(--gradient-card);
            border: 1px solid hsl(var(--valorant-red) / 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-neon);
        }

        .leader-panel.active {
            display: block;
        }

        .leader-panel h3 {
            font-family: 'Orbitron', monospace;
            color: hsl(var(--valorant-red));
            margin-bottom: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .leader-steps {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .leader-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: hsl(var(--muted) / 0.3);
            border-radius: 0.5rem;
            border-left: 3px solid hsl(var(--valorant-red));
        }

        .step-number {
            background: hsl(var(--valorant-red));
            color: hsl(var(--primary-foreground));
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
        }

        .step-description {
            color: hsl(var(--muted-foreground));
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .step-input {
            display: flex;
            gap: 0.5rem;
        }

        .step-input input {
            flex: 1;
            padding: 0.5rem;
            background: hsl(var(--input));
            border: 1px solid hsl(var(--border));
            border-radius: 0.25rem;
            color: hsl(var(--foreground));
        }

        .step-input button {
            padding: 0.5rem 1rem;
            background: var(--gradient-neon);
            color: hsl(var(--primary-foreground));
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 600;
        }

        /* Login Section */
        .login-section {
            text-align: center;
            padding: 4rem 2rem;
        }

        .login-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            color: hsl(var(--valorant-red));
            margin-bottom: 1rem;
        }

        .login-description {
            color: hsl(var(--muted-foreground));
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .discord-login-btn {
            background: #5865F2;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .discord-login-btn:hover {
            background: #4752C4;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(88, 101, 242, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }
            
            .header .container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-tabs {
                width: 100%;
                justify-content: center;
            }
            
            .user-card {
                margin: 1rem;
            }
            
            .lobby-container {
                padding: 0 0.5rem;
            }
        }

        /* Background Effects */
        .background-effects {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: -1;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            animation: float 6s ease-in-out infinite;
        }

        .orb-1 {
            top: 25%;
            left: 25%;
            width: 16rem;
            height: 16rem;
            background: radial-gradient(circle, rgba(255, 70, 85, 0.1), transparent);
        }

        .orb-2 {
            bottom: 33%;
            right: 33%;
            width: 12rem;
            height: 12rem;
            background: radial-gradient(circle, rgba(74, 158, 255, 0.1), transparent);
            animation-delay: 1s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
            }
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="background-effects">
        <div class="bg-orb orb-1"></div>
        <div class="bg-orb orb-2"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                VALORANT <span class="accent">10-MANS</span>
            </div>
            <nav class="nav-tabs">
                <a href="#" class="nav-tab">🏆 Leaderboard</a>
                <a href="#" class="nav-tab">⚔️ Matches</a>
                <a href="#" class="nav-tab active">🎮 Play</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Login Section (shown when not logged in) -->
            <div id="loginSection" class="login-section">
                <h1 class="login-title">Bienvenido a los 10-Mans</h1>
                <p class="login-description">Inicia sesión con Discord para unirte a las partidas competitivas</p>
                <button class="discord-login-btn" onclick="loginWithDiscord()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.210 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.210 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    Iniciar sesión con Discord
                </button>
            </div>

            <!-- User Card (shown when logged in) -->
            <div id="userCard" class="user-card" style="display: none;">
                <div class="user-card-bg" id="userCardBg"></div>
                <div class="user-card-content">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <h2 id="userName" class="user-name"></h2>
                    <p id="userStatus" class="user-status">Listo para jugar</p>
                    
                    <button id="playButton" class="play-button" onclick="toggleQueue()">
                        🎮 PLAY
                    </button>
                    
                    <div id="queueTimer" class="queue-timer" style="display: none;">
                        Tiempo en cola: <span id="timerValue">00:00</span>
                    </div>
                    
                    <button class="change-bg-btn" onclick="openBackgroundModal()">
                        🎨 Cambiar fondo
                    </button>
                </div>
            </div>

            <!-- Leader Panel -->
            <div id="leaderPanel" class="leader-panel">
                <h3>👑 Panel del Líder</h3>
                <div class="leader-steps">
                    <div class="leader-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Crear sala en Valorant</div>
                            <div class="step-description">
                                Modo personalizado → Configuración estándar de competitivo → Mapa: <strong id="assignedMap">Ascent</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="leader-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Ingresar código de sala</div>
                            <div class="step-description">
                                Comparte el código con los 10 jugadores
                            </div>
                            <div class="step-input">
                                <input type="text" id="roomCodeInput" placeholder="Código de la sala (ej: VALORANT123)">
                                <button onclick="submitRoomCode()">Enviar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="leader-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Subir resultado del tracker</div>
                            <div class="step-description">
                                Una vez finalizada la partida, ingresa la URL del Tracker.gg
                            </div>
                            <div class="step-input">
                                <input type="text" id="trackerUrlInput" placeholder="https://tracker.gg/valorant/match/...">
                                <button onclick="submitTrackerUrl()">Subir</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lobby Container -->
            <div id="lobbyContainer" class="lobby-container">
                <div class="lobby-header">
                    <h1 class="lobby-title">🎮 LOBBY DE PARTIDA</h1>
                    <p class="lobby-info">Mapa: <span id="lobbyMap">Ascent</span> | Líder: <span id="lobbyLeader">-</span></p>
                </div>
                
                <div class="teams-container">
                    <div class="team team-a">
                        <h3 class="team-title">TEAM A</h3>
                        <div id="teamAPlayers"></div>
                    </div>
                    
                    <div class="team team-b">
                        <h3 class="team-title">TEAM B</h3>
                        <div id="teamBPlayers"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Background Modal -->
    <div id="backgroundModal" class="bg-modal">
        <div class="bg-modal-content">
            <h3>🎨 Cambiar fondo de tarjeta</h3>
            <div class="bg-options">
                <div class="bg-option" data-bg="default" style="background: linear-gradient(135deg, hsl(350 85% 55% / 0.2), hsl(195 85% 55% / 0.1));"></div>
                <div class="bg-option" data-bg="valorant1" style="background: url('https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400') center/cover;"></div>
                <div class="bg-option" data-bg="valorant2" style="background: url('https://images.unsplash.com/photo-1511512578047-dfb367046420?w=400') center/cover;"></div>
                <div class="bg-option" data-bg="valorant3" style="background: url('https://images.unsplash.com/photo-1538481199705-c710c4e965fc?w=400') center/cover;"></div>
            </div>
            <input type="url" class="custom-url-input" id="customBgUrl" placeholder="O ingresa una URL personalizada...">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeBackgroundModal()">Cancelar</button>
                <button class="modal-btn primary" onclick="saveBackground()">Guardar</button>
            </div>
        </div>
    </div>

<script>
const API_BASE = 'https://valorant-10-mans.onrender.com'; 

// Estado global
let currentUser = null;
let isInQueue = false;
let queueStartTime = null;
let queueTimer = null;
let currentMatch = null;
let selectedBackground = 'default';

// Fondos predeterminados
const backgrounds = {
    default: 'linear-gradient(135deg, hsl(350 85% 55% / 0.2), hsl(195 85% 55% / 0.1))',
    valorant1: 'url("https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400") center/cover',
    valorant2: 'url("https://images.unsplash.com/photo-1511512578047-dfb367046420?w=400") center/cover',
    valorant3: 'url("https://images.unsplash.com/photo-1538481199705-c710c4e965fc?w=400") center/cover'
};

// Maps posibles
const maps = ['Ascent', 'Bind', 'Haven', 'Split', 'Icebox', 'Breeze', 'Fracture', 'Pearl', 'Lotus', 'Sunset'];

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    checkAuthStatus();
    setupBackgroundSelection();
    startPeriodicUpdates();
});

// =========================
// Autenticación
// =========================
async function checkAuthStatus() {
    try {
        const res = await fetch(`${API_BASE}/api/users/me`, { credentials: 'include' });
        if (res.ok) {
            currentUser = await res.json();
            showUserInterface();
            await checkQueueStatus();
        } else showLoginInterface();
    } catch (e) { console.error(e); showLoginInterface(); }
}

function loginWithDiscord() {
    window.location.href = `${API_BASE}/api/auth/discord`;
}

function showLoginInterface() {
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('userCard').style.display = 'none';
    document.getElementById('lobbyContainer').classList.remove('active');
    document.getElementById('leaderPanel').classList.remove('active');
}

function showUserInterface() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('userCard').style.display = 'block';
    document.getElementById('userAvatar').src = currentUser.avatar
  ? `https://cdn.discordapp.com/avatars/${currentUser.discordId}/${currentUser.avatar}.png`
  : '/placeholder.svg';
    document.getElementById('userName').textContent = currentUser.username || 'Usuario';

    const bgElement = document.getElementById('userCardBg');
    if (currentUser.cardBackground) {
        if (currentUser.cardBackground.startsWith('http')) {
            bgElement.style.background = `url("${currentUser.cardBackground}") center/cover`;
        } else {
            bgElement.style.background = backgrounds[currentUser.cardBackground] || backgrounds.default;
        }
    }
    updateUserStatus();
}

function updateUserStatus() {
    const statusElement = document.getElementById('userStatus');
    if (!currentUser.riotId) {
        statusElement.textContent = '⚠️ Registra tu Riot ID para jugar';
        statusElement.style.color = 'hsl(45 85% 55%)';
    } else if (isInQueue) {
        statusElement.textContent = '🔄 En cola...';
        statusElement.style.color = 'hsl(195 85% 55%)';
    } else {
        statusElement.textContent = 'Listo para jugar';
        statusElement.style.color = 'hsl(var(--muted-foreground))';
    }
}

// =========================
// Cola
// =========================
async function toggleQueue() {
    if (!currentUser.riotId) {
        const riotId = prompt('Ingresa tu Riot ID:');
        if (riotId) await updateRiotId(riotId);
        return;
    }
    if (isInQueue) await leaveQueue();
    else await joinQueue();
}

async function joinQueue() {
    try {
        const res = await fetch(`${API_BASE}/api/queue/join`, { method: 'POST', credentials: 'include' });
        if (res.ok) {
            isInQueue = true;
            queueStartTime = Date.now();
            updatePlayButton();
            startQueueTimer();
            updateUserStatus();
        }
    } catch (e) { console.error(e); }
}

async function leaveQueue() {
    try {
        const res = await fetch(`${API_BASE}/api/queue/leave-global`, { method: 'POST', credentials: 'include' });
        if (res.ok) {
            isInQueue = false;
            queueStartTime = null;
            updatePlayButton();
            stopQueueTimer();
            updateUserStatus();
        }
    } catch (e) { console.error(e); }
}

async function checkQueueStatus() {
    try {
        const res = await fetch(`${API_BASE}/api/queue/my-match`, { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();

        if (data.match) {
            currentMatch = data.match;
            showLobby(data.match);
        } else if (data.inQueueGlobal) {
            isInQueue = true;
            if (!queueStartTime) queueStartTime = Date.now() - (data.queueTime || 0);
            updatePlayButton();
            startQueueTimer();
            updateUserStatus();
        } else {
            isInQueue = false;
            currentMatch = null;
            hideLobby();
            updatePlayButton();
            stopQueueTimer();
            updateUserStatus();
        }
    } catch (e) { console.error(e); }
}

function updatePlayButton() {
    const btn = document.getElementById('playButton');
    btn.textContent = isInQueue ? '❌ SALIR DE COLA' : '🎮 PLAY';
    btn.disabled = !currentUser.riotId;
}

function startQueueTimer() {
    const timerEl = document.getElementById('queueTimer');
    const timerValue = document.getElementById('timerValue');
    timerEl.style.display = 'block';
    queueTimer = setInterval(() => {
        if (!queueStartTime) return;
        const elapsed = Math.floor((Date.now() - queueStartTime)/1000);
        const min = Math.floor(elapsed/60).toString().padStart(2,'0');
        const sec = (elapsed%60).toString().padStart(2,'0');
        timerValue.textContent = `${min}:${sec}`;
    }, 1000);
}

function stopQueueTimer() {
    const timerEl = document.getElementById('queueTimer');
    timerEl.style.display = 'none';
    if (queueTimer) { clearInterval(queueTimer); queueTimer=null; }
}

// =========================
// Fondo de tarjeta
// =========================
function setupBackgroundSelection() {
    const bgOptions = document.querySelectorAll('.bg-option');
    bgOptions.forEach(opt => {
        opt.addEventListener('click', () => {
            bgOptions.forEach(o=>o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedBackground = opt.dataset.bg;
        });
    });
}

function openBackgroundModal() { document.getElementById('backgroundModal').classList.add('active'); }
function closeBackgroundModal() { document.getElementById('backgroundModal').classList.remove('active'); }

async function saveBackground() {
    const url = document.getElementById('customBgUrl').value;
    const bg = url || selectedBackground;
    try {
        const res = await fetch(`${API_BASE}/api/users/update-card-background`, {
            method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({background:bg})
        });
        if (res.ok) {
            currentUser.cardBackground = bg;
            const bgEl = document.getElementById('userCardBg');
            if (bg.startsWith('http')) bgEl.style.background = `url("${bg}") center/cover`;
            else bgEl.style.background = backgrounds[bg] || backgrounds.default;
            closeBackgroundModal();
        }
    } catch(e){console.error(e);}
}

async function updateRiotId(riotId) {
    try {
        const res = await fetch(`${API_BASE}/api/users/update-riot`, {
            method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({riotId})
        });
        if (res.ok) { currentUser.riotId = riotId; updateUserStatus(); updatePlayButton(); }
    } catch(e){console.error(e);}
}

// =========================
// Lobby
// =========================
function showLobby(match) {
    document.getElementById('userCard').style.display='none';
    document.getElementById('lobbyContainer').classList.add('active');
    if(match.leader && match.leader.id===currentUser.id) document.getElementById('leaderPanel').classList.add('active');

    document.getElementById('lobbyMap').textContent = match.map || getRandomMap();
    document.getElementById('lobbyLeader').textContent = match.leader?.username || 'Desconocido';
    renderTeam('teamAPlayers', match.teamA||[]);
    renderTeam('teamBPlayers', match.teamB||[]);
}

function hideLobby() {
    document.getElementById('userCard').style.display='block';
    document.getElementById('lobbyContainer').classList.remove('active');
    document.getElementById('leaderPanel').classList.remove('active');
}

function renderTeam(containerId, players) {
    const cont = document.getElementById(containerId);
    cont.innerHTML = '';
    players.forEach(p=>{
        const card = document.createElement('div');
        card.className='player-card';
        if(p.cardBackground){
            const bg = p.cardBackground.startsWith('http')?`url("${p.cardBackground}") center/cover`:(backgrounds[p.cardBackground]||'');
            card.style.setProperty('--player-bg', bg);
            card.style.backgroundImage=bg;
            card.style.backgroundSize='cover';
            card.style.backgroundPosition='center';
            card.style.opacity='0.8';
        }
        card.innerHTML=`
        <div class="player-card-content">
            <img class="player-avatar-small" src="${p.avatar ? `https://cdn.discordapp.com/avatars/${p.id}/${p.avatar}.png` : '/placeholder.svg'}">
            <div class="player-info">
                <div class="player-name-small">${p.username}</div>
                <div class="player-riot-id">${p.riotId||'Sin Riot ID'}</div>
            </div>
            ${currentMatch?.leader?.id===p.id?'<div class="leader-badge">👑 LÍDER</div>':''}
        </div>`;
        cont.appendChild(card);
    });
}

function getRandomMap() { return maps[Math.floor(Math.random()*maps.length)]; }

// =========================
// Líder
// =========================
async function submitRoomCode() {
    const val = document.getElementById('roomCodeInput').value.trim();
    if(!val){ alert('Ingresa código'); return; }
    try { 
        await fetch(`${API_BASE}/api/match/submit-room`, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({roomCode:val}) });
        alert('Código enviado');
        document.getElementById('roomCodeInput').value='';
    } catch(e){console.error(e);}
}

async function submitTrackerUrl() {
    const val = document.getElementById('trackerUrlInput').value.trim();
    if(!val){ alert('Ingresa tracker'); return; }
    try { 
        await fetch(`${API_BASE}/api/match/submit-tracker`, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({trackerUrl:val}) });
        alert('Tracker enviado');
        document.getElementById('trackerUrlInput').value='';
    } catch(e){console.error(e);}
}

// =========================
// Actualizaciones periódicas
// =========================
function startPeriodicUpdates() {
    setInterval(async()=>{
        if(currentUser) await checkQueueStatus();
    },10000);
}
</script>

</body>
</html>
