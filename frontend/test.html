<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AceHub 10-Mans</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #1c1c1c;
    color: #eee;
    margin: 0;
    padding: 0;
  }
  header {
    background-color: #2c2c2c;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  button {
    background-color: #5865F2;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
  }
  button:hover {
    background-color: #4752c4;
  }
  .hidden {
    display: none;
  }
  #user-profile {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #user-profile img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
  }
  #queues-container, #match-info {
    margin-top: 10px;
  }
  .queue-item {
    background-color: #2c2c2c;
    padding: 8px;
    margin-bottom: 6px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
  }
</style>
</head>
<body>
<header>
  <h1>AceHub 10-Mans</h1>
  <div id="user-info">
    <button id="login-btn">Login con Discord</button>
    <div id="user-profile" class="hidden">
      <img id="avatar" src="" alt="Avatar">
      <span id="username"></span>
      <button id="logout-btn">Cerrar sesión</button>
    </div>
  </div>
</header>

<main>
  <section id="queues-section" class="hidden">
    <h2>Colas disponibles</h2>
    <div id="queues-container"></div>
  </section>

  <section id="match-section" class="hidden">
    <h2>Partida actual</h2>
    <div id="match-info"></div>
    <button id="confirm-match-btn">Confirmar participación</button>
  </section>
</main>

<script>
const API_BASE = "https://valorant-10-mans.onrender.com/api";
const DISCORD_OAUTH_URL = "https://discord.com/api/oauth2/authorize?client_id=TU_CLIENT_ID&redirect_uri=https%3A%2F%2Fvalorant-10-mans-frontend.onrender.com%2F&response_type=code&scope=identify";

const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userProfile = document.getElementById("user-profile");
const avatarImg = document.getElementById("avatar");
const usernameSpan = document.getElementById("username");

const queuesSection = document.getElementById("queues-section");
const queuesContainer = document.getElementById("queues-container");

const matchSection = document.getElementById("match-section");
const matchInfo = document.getElementById("match-info");
const confirmMatchBtn = document.getElementById("confirm-match-btn");

let currentUser = null;

// ----------------- LOGIN -----------------
loginBtn.addEventListener("click", () => {
  window.location.href = DISCORD_OAUTH_URL;
});

logoutBtn.addEventListener("click", async () => {
  await fetch(`${API_BASE}/auth/logout`, { method: "POST", credentials: "include" });
  currentUser = null;
  updateUI();
});

// ----------------- CHECK SESSION -----------------
async function fetchUser() {
  try {
    const res = await fetch(`${API_BASE}/auth/me`, { credentials: "include" });
    if (res.ok) {
      currentUser = await res.json();
    } else {
      currentUser = null;
    }
    updateUI();
  } catch (err) {
    console.error(err);
  }
}

// ----------------- UPDATE UI -----------------
function updateUI() {
  if (currentUser) {
    loginBtn.classList.add("hidden");
    userProfile.classList.remove("hidden");
    avatarImg.src = currentUser.avatarURL;
    usernameSpan.textContent = currentUser.username;
    queuesSection.classList.remove("hidden");
    matchSection.classList.remove("hidden");
    loadQueues();
    loadCurrentMatch();
  } else {
    loginBtn.classList.remove("hidden");
    userProfile.classList.add("hidden");
    queuesSection.classList.add("hidden");
    matchSection.classList.add("hidden");
  }
}

// ----------------- QUEUES -----------------
async function loadQueues() {
  queuesContainer.innerHTML = "Cargando...";
  try {
    const res = await fetch(`${API_BASE}/queue/public/LAS`);
    const queue = await res.json();
    queuesContainer.innerHTML = "";
    queue.forEach(player => {
      const div = document.createElement("div");
      div.className = "queue-item";
      div.textContent = player.discordId;
      queuesContainer.appendChild(div);
    });

    const joinBtn = document.createElement("button");
    joinBtn.textContent = "Unirse a la cola";
    joinBtn.addEventListener("click", () => joinQueue());
    queuesContainer.appendChild(joinBtn);
  } catch (err) {
    console.error(err);
    queuesContainer.innerHTML = "Error cargando cola.";
  }
}

async function joinQueue() {
  if (!currentUser) return;
  const body = { userId: currentUser.discordId, type: "public", region: "LAS" };
  try {
    const res = await fetch(`${API_BASE}/queue/join`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.success) {
      loadQueues();
      loadCurrentMatch();
    } else alert(data.error);
  } catch (err) { console.error(err); }
}

// ----------------- MATCH -----------------
async function loadCurrentMatch() {
  try {
    const res = await fetch(`${API_BASE}/matches/active`, { credentials: "include" });
    if (res.ok) {
      const match = await res.json();
      if (match) {
        matchInfo.innerHTML = `
          <p>ID: ${match._id}</p>
          <p>Mapa: ${match.map}</p>
          <p>Tipo: ${match.type}</p>
          <p>Jugadores: ${match.players.map(p => p.discordId).join(", ")}</p>
        `;
      } else matchInfo.textContent = "No hay partida activa.";
    }
  } catch (err) { console.error(err); }
}

confirmMatchBtn.addEventListener("click", async () => {
  if (!currentUser) return;
  const matchRes = await fetch(`${API_BASE}/matches/active`, { credentials: "include" });
  const match = await matchRes.json();
  if (!match) return alert("No hay partida activa.");

  const body = { matchId: match._id, userId: currentUser.discordId, accepted: true };
  const res = await fetch(`${API_BASE}/match/confirm`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (data.success) alert("Has confirmado tu participación");
  loadCurrentMatch();
});

// ----------------- INIT -----------------
fetchUser();
</script>
</body>
</html>

